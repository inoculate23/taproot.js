(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&s(o)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();let V=r=>r==null||r===""||r==="null"||Array.isArray(r)&&r.length===0||typeof r=="object"&&r.constructor.name==="Object"&&Object.getOwnPropertyNames(r).length===0,fe=()=>"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+r/4).toString(16)),de=r=>{let e=r.reduce((i,n)=>i+n.length,0),t=new r[0].constructor(e),s=0;return r.forEach(i=>{t.set(i,s),s+=i.length}),t};class b{constructor(e,t=null,s=null){if(e instanceof b)this.data=e.data,this.shape=e.shape,this.dtype=e.dtype;else if(b.isTypedArray(e)){let i=b.getDataTypeFromTypedArray(e);s!==null&&i!==s?(this.data=new(b.getArrayConstructorFromDataType(s))(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)),this.dtype=s):(this.data=e,this.dtype=i),t===null&&(t=[e.length]),this.shape=t}else if(s!==null)this.data=new(b.getArrayConstructorFromDataType(s))(e),t===null&&(t=[e.length]),this.shape=t,this.dtype=s;else if(Array.isArray(e))this.data=new Int32Array(e),this.shape=[e.length],this.dtype="int32";else throw new Error(`Invalid data type ${typeof e} (${e.constructor.name})`)}get(){let e=Array.from(arguments);if(e.length!==this.shape.length)throw new Error("Incorrect number of indexes");let t=0;for(let s=0;s<e.length;s++)t+=e[s]*this.strides[s];return this.data[t]}set(){let e=Array.from(arguments),t=e.pop();if(e.length!==this.shape.length)throw new Error("Incorrect number of indexes");let s=0;for(let i=0;i<e.length;i++)s+=e[i]*this.strides[i];this.data[s]=t}get packed(){return{type:"ndarray",shape:this.shape,dtype:this.dtype,data:this.data}}get imageData(){if(this.shape.length!==3)throw new Error("Can only get ImageData from 3D array (height, width, channels)");let[e,t,s]=this.shape;if(s===3){let i=new Uint8ClampedArray(t*e*4);for(let n=0;n<t*e;n++)i[n*4]=this.data[n*3],i[n*4+1]=this.data[n*3+1],i[n*4+2]=this.data[n*3+2],i[n*4+3]=255;return new ImageData(i,t,e)}return new ImageData(new Uint8ClampedArray(this.data.buffer.slice(this.data.byteOffset,this.data.byteOffset+this.data.byteLength)),t,e)}static getDataTypeFromTypedArray(e){if(b.isTypedArray(e))return e.constructor.name.replace("Array","").toLowerCase();throw new Error(`Not a typed array: ${e.constructor.name}`)}static getArrayConstructorFromDataType(e){switch(e){case"float32":return Float32Array;case"float64":return Float64Array;case"int8":return Int8Array;case"int16":return Int16Array;case"int32":return Int32Array;case"uint8":return Uint8Array;case"uint16":return Uint16Array;case"uint32":return Uint32Array;default:throw new Error(`Unknown data type: ${e}`)}}static isTypedArray(e){return e instanceof Float32Array||e instanceof Float64Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array}toString(){return`NDArray(${this.data}, ${this.shape}, ${this.dtype})`}}function Re(r){const e=r.length;let t=0,s=0;for(;s<e;){let i=r.charCodeAt(s++);if((i&4294967168)===0){t++;continue}else if((i&4294965248)===0)t+=2;else{if(i>=55296&&i<=56319&&s<e){const n=r.charCodeAt(s);(n&64512)===56320&&(++s,i=((i&1023)<<10)+(n&1023)+65536)}(i&4294901760)===0?t+=3:t+=4}}return t}function _e(r,e,t){const s=r.length;let i=t,n=0;for(;n<s;){let o=r.charCodeAt(n++);if((o&4294967168)===0){e[i++]=o;continue}else if((o&4294965248)===0)e[i++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&n<s){const a=r.charCodeAt(n);(a&64512)===56320&&(++n,o=((o&1023)<<10)+(a&1023)+65536)}(o&4294901760)===0?(e[i++]=o>>12&15|224,e[i++]=o>>6&63|128):(e[i++]=o>>18&7|240,e[i++]=o>>12&63|128,e[i++]=o>>6&63|128)}e[i++]=o&63|128}}const Ne=new TextEncoder,He=50;function Ke(r,e,t){Ne.encodeInto(r,e.subarray(t))}function Ve(r,e,t){r.length>He?Ke(r,e,t):_e(r,e,t)}const qe=4096;function be(r,e,t){let s=e;const i=s+t,n=[];let o="";for(;s<i;){const a=r[s++];if((a&128)===0)n.push(a);else if((a&224)===192){const h=r[s++]&63;n.push((a&31)<<6|h)}else if((a&240)===224){const h=r[s++]&63,f=r[s++]&63;n.push((a&31)<<12|h<<6|f)}else if((a&248)===240){const h=r[s++]&63,f=r[s++]&63,w=r[s++]&63;let u=(a&7)<<18|h<<12|f<<6|w;u>65535&&(u-=65536,n.push(u>>>10&1023|55296),u=56320|u&1023),n.push(u)}else n.push(a);n.length>=qe&&(o+=String.fromCharCode(...n),n.length=0)}return n.length>0&&(o+=String.fromCharCode(...n)),o}const Je=new TextDecoder,Xe=200;function Ye(r,e,t){const s=r.subarray(e,e+t);return Je.decode(s)}function Ge(r,e,t){return t>Xe?Ye(r,e,t):be(r,e,t)}class Y{constructor(e,t){this.type=e,this.data=t}}class S extends Error{constructor(e){super(e);const t=Object.create(S.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:S.name})}}const _=4294967295;function Ze(r,e,t){const s=t/4294967296,i=t;r.setUint32(e,s),r.setUint32(e+4,i)}function Ae(r,e,t){const s=Math.floor(t/4294967296),i=t;r.setUint32(e,s),r.setUint32(e+4,i)}function Se(r,e){const t=r.getInt32(e),s=r.getUint32(e+4);return t*4294967296+s}function Qe(r,e){const t=r.getUint32(e),s=r.getUint32(e+4);return t*4294967296+s}const je=-1,et=4294967296-1,tt=17179869184-1;function st({sec:r,nsec:e}){if(r>=0&&e>=0&&r<=tt)if(e===0&&r<=et){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,r),t}else{const t=r/4294967296,s=r&4294967295,i=new Uint8Array(8),n=new DataView(i.buffer);return n.setUint32(0,e<<2|t&3),n.setUint32(4,s),i}else{const t=new Uint8Array(12),s=new DataView(t.buffer);return s.setUint32(0,e),Ae(s,4,r),t}}function it(r){const e=r.getTime(),t=Math.floor(e/1e3),s=(e-t*1e3)*1e6,i=Math.floor(s/1e9);return{sec:t+i,nsec:s-i*1e9}}function rt(r){if(r instanceof Date){const e=it(r);return st(e)}else return null}function nt(r){const e=new DataView(r.buffer,r.byteOffset,r.byteLength);switch(r.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{const t=e.getUint32(0),s=e.getUint32(4),i=(t&3)*4294967296+s,n=t>>>2;return{sec:i,nsec:n}}case 12:{const t=Se(e,4),s=e.getUint32(0);return{sec:t,nsec:s}}default:throw new S(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${r.length}`)}}function ot(r){const e=nt(r);return new Date(e.sec*1e3+e.nsec/1e6)}const at={type:je,encode:rt,decode:ot};class Z{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(at)}register({type:e,encode:t,decode:s}){if(e>=0)this.encoders[e]=t,this.decoders[e]=s;else{const i=-1-e;this.builtInEncoders[i]=t,this.builtInDecoders[i]=s}}tryToEncode(e,t){for(let s=0;s<this.builtInEncoders.length;s++){const i=this.builtInEncoders[s];if(i!=null){const n=i(e,t);if(n!=null){const o=-1-s;return new Y(o,n)}}}for(let s=0;s<this.encoders.length;s++){const i=this.encoders[s];if(i!=null){const n=i(e,t);if(n!=null){const o=s;return new Y(o,n)}}}return e instanceof Y?e:null}decode(e,t,s){const i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,s):new Y(t,e)}}Z.defaultCodec=new Z;function ht(r){return r instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&r instanceof SharedArrayBuffer}function te(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):ht(r)?new Uint8Array(r):Uint8Array.from(r)}const ct=100,lt=2048;let ft=class Be{constructor(e){this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Z.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.maxDepth=(e==null?void 0:e.maxDepth)??ct,this.initialBufferSize=(e==null?void 0:e.initialBufferSize)??lt,this.sortKeys=(e==null?void 0:e.sortKeys)??!1,this.forceFloat32=(e==null?void 0:e.forceFloat32)??!1,this.ignoreUndefined=(e==null?void 0:e.ignoreUndefined)??!1,this.forceIntegerToFloat=(e==null?void 0:e.forceIntegerToFloat)??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new Be({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){const t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){const t=new ArrayBuffer(e),s=new Uint8Array(t),i=new DataView(t);s.set(this.bytes),this.view=i,this.bytes=s}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){const s=Re(e);this.ensureBufferSizeToWrite(5+s),this.writeStringHeader(s),Ve(e,this.bytes,this.pos),this.pos+=s}encodeObject(e,t){const s=this.extensionCodec.tryToEncode(e,this.context);if(s!=null)this.encodeExtension(s);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){const t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);const s=te(e);this.writeU8a(s)}encodeArray(e,t){const s=e.length;if(s<16)this.writeU8(144+s);else if(s<65536)this.writeU8(220),this.writeU16(s);else if(s<4294967296)this.writeU8(221),this.writeU32(s);else throw new Error(`Too large array: ${s}`);for(const i of e)this.doEncode(i,t+1)}countWithoutUndefined(e,t){let s=0;for(const i of t)e[i]!==void 0&&s++;return s}encodeMap(e,t){const s=Object.keys(e);this.sortKeys&&s.sort();const i=this.ignoreUndefined?this.countWithoutUndefined(e,s):s.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else if(i<4294967296)this.writeU8(223),this.writeU32(i);else throw new Error(`Too large map object: ${i}`);for(const n of s){const o=e[n];this.ignoreUndefined&&o===void 0||(this.encodeString(n),this.doEncode(o,t+1))}}encodeExtension(e){if(typeof e.data=="function"){const s=e.data(this.pos+6),i=s.length;if(i>=4294967296)throw new Error(`Too large extension object: ${i}`);this.writeU8(201),this.writeU32(i),this.writeI8(e.type),this.writeU8a(s);return}const t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){const t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),Ze(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),Ae(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function dt(r,e){return new ft(e).encodeSharedRef(r)}function j(r){return`${r<0?"-":""}0x${Math.abs(r).toString(16).padStart(2,"0")}`}const ut=16,gt=16;class yt{constructor(e=ut,t=gt){this.hit=0,this.miss=0,this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let s=0;s<this.maxKeyLength;s++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,s){const i=this.caches[s-1];e:for(const n of i){const o=n.bytes;for(let a=0;a<s;a++)if(o[a]!==e[t+a])continue e;return n.str}return null}store(e,t){const s=this.caches[e.length-1],i={bytes:e,str:t};s.length>=this.maxLengthPerKey?s[Math.random()*s.length|0]=i:s.push(i)}decode(e,t,s){const i=this.find(e,t,s);if(i!=null)return this.hit++,i;this.miss++;const n=be(e,t,s),o=Uint8Array.prototype.slice.call(e,t,t+s);return this.store(o,n),n}}const se="array",J="map_key",ve="map_value",pt=r=>{if(typeof r=="string"||typeof r=="number")return r;throw new S("The type of key must be string or number but "+typeof r)};class wt{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){const t=this.getUninitializedStateFromPool();t.type=se,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){const t=this.getUninitializedStateFromPool();t.type=J,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){const e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===se){const s=e;s.size=0,s.array=void 0,s.position=0,s.type=void 0}if(e.type===J||e.type===ve){const s=e;s.size=0,s.map=void 0,s.readCount=0,s.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}const N=-1,ae=new DataView(new ArrayBuffer(0)),mt=new Uint8Array(ae.buffer);try{ae.getInt8(0)}catch(r){if(!(r instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}const ue=new RangeError("Insufficient data"),xt=new yt;class he{constructor(e){this.totalPos=0,this.pos=0,this.view=ae,this.bytes=mt,this.headByte=N,this.stack=new wt,this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Z.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.rawStrings=(e==null?void 0:e.rawStrings)??!1,this.maxStrLength=(e==null?void 0:e.maxStrLength)??_,this.maxBinLength=(e==null?void 0:e.maxBinLength)??_,this.maxArrayLength=(e==null?void 0:e.maxArrayLength)??_,this.maxMapLength=(e==null?void 0:e.maxMapLength)??_,this.maxExtLength=(e==null?void 0:e.maxExtLength)??_,this.keyDecoder=(e==null?void 0:e.keyDecoder)!==void 0?e.keyDecoder:xt,this.mapKeyConverter=(e==null?void 0:e.mapKeyConverter)??pt}clone(){return new he({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=N,this.stack.reset()}setBuffer(e){const t=te(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===N&&!this.hasRemaining(1))this.setBuffer(e);else{const t=this.bytes.subarray(this.pos),s=te(e),i=new Uint8Array(t.length+s.length);i.set(t),i.set(s,t.length),this.setBuffer(i)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){const{view:t,pos:s}=this;return new RangeError(`Extra ${t.byteLength-s} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);const t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,s;for await(const a of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{s=this.doDecodeSync(),t=!0}catch(h){if(!(h instanceof RangeError))throw h}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return s}const{headByte:i,pos:n,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${j(i)} at ${o} (${n} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let s=t,i=-1;for await(const n of e){if(t&&i===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(n),s&&(i=this.readArraySize(),s=!1,this.complete());try{for(;yield this.doDecodeSync(),--i!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){const e=this.readHeadByte();let t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){const i=e-128;if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e<160){const i=e-144;if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else{const i=e-160;t=this.decodeString(i,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){const i=this.lookU8();t=this.decodeString(i,1)}else if(e===218){const i=this.lookU16();t=this.decodeString(i,2)}else if(e===219){const i=this.lookU32();t=this.decodeString(i,4)}else if(e===220){const i=this.readU16();if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else if(e===221){const i=this.readU32();if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else if(e===222){const i=this.readU16();if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e===223){const i=this.readU32();if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e===196){const i=this.lookU8();t=this.decodeBinary(i,1)}else if(e===197){const i=this.lookU16();t=this.decodeBinary(i,2)}else if(e===198){const i=this.lookU32();t=this.decodeBinary(i,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){const i=this.lookU8();t=this.decodeExtension(i,1)}else if(e===200){const i=this.lookU16();t=this.decodeExtension(i,2)}else if(e===201){const i=this.lookU32();t=this.decodeExtension(i,4)}else throw new S(`Unrecognized type byte: ${j(e)}`);this.complete();const s=this.stack;for(;s.length>0;){const i=s.top();if(i.type===se)if(i.array[i.position]=t,i.position++,i.position===i.size)t=i.array,s.release(i);else continue e;else if(i.type===J){if(t==="__proto__")throw new S("The key __proto__ is not allowed");i.key=this.mapKeyConverter(t),i.type=ve;continue e}else if(i.map[i.key]=t,i.readCount++,i.readCount===i.size)t=i.map,s.release(i);else{i.key=null,i.type=J;continue e}}return t}}readHeadByte(){return this.headByte===N&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=N}readArraySize(){const e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new S(`Unrecognized array type byte: ${j(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new S(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new S(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){var n;if(e>this.maxStrLength)throw new S(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw ue;const s=this.pos+t;let i;return this.stateIsMapKey()&&((n=this.keyDecoder)!=null&&n.canBeCached(e))?i=this.keyDecoder.decode(this.bytes,s,e):i=Ge(this.bytes,s,e),this.pos+=t+e,i}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===J:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new S(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw ue;const s=this.pos+t,i=this.bytes.subarray(s,s+e);return this.pos+=t+e,i}decodeExtension(e,t){if(e>this.maxExtLength)throw new S(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);const s=this.view.getInt8(this.pos+t),i=this.decodeBinary(e,t+1);return this.extensionCodec.decode(i,s,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){const e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){const e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){const e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){const e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){const e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){const e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){const e=Qe(this.view,this.pos);return this.pos+=8,e}readI64(){const e=Se(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){const e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){const e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){const e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){const e=this.view.getFloat64(this.pos);return this.pos+=8,e}}function Ut(r,e){return new he(e).decode(r)}function kt(r){switch(r){case"Number":return"int";case"Boolean":return"bool";case"String":return"str";case"Array":return"list";case"Object":return"dict";case"ArrayBuffer":case"Blob":return"bytes";case"t":return"ndarray";default:return r}}function It(r){return new Promise((e,t)=>{let s=new FileReader;s.onload=()=>{e(new Uint8Array(s.result)),s.close()},s.onerror=()=>{t(s.error),s.close()},s.readAsArrayBuffer(r)})}function Et(r){let e=r.src;if(e)return e.startsWith("data")?e.split(";")[0].split(":")[1]:e.endsWith(".png")?"image/png":e.endsWith(".jpg")||e.endsWith(".jpeg")?"image/jpeg":e.endsWith(".gif")?"image/gif":e.endsWith(".bmp")?"image/bmp":"image/png"}async function Te(r,e=null){return{type:"bytes",data:await It(r),dtype:r.type}}function bt(r){return new Promise((e,t)=>{let s=document.createElement("canvas"),i=s.getContext("2d"),n=Et(r);s.width=datum.width,s.height=datum.height,i.drawImage(datum,0,0),s.toBlob(o=>{Te(o,n).then(e).catch(t)},n)})}class v{static async pack(e){if(e==null)return{type:"null"};if(e instanceof ArrayBuffer)return{type:"bytes",data:new Uint8Array(e)};if(e instanceof Blob)return await Te(e);if(e instanceof b)return e.packed;if(b.isTypedArray(e))return new b(e).packed;if(typeof Image<"u"&&e instanceof Image)return await bt(e);if(typeof e=="function")return{type:"type",dtype:kt(e.name)};if(typeof e=="number")return{type:e%1===0?"int":"float",data:e};if(typeof e=="boolean")return{type:"bool",data:e};if(typeof e=="string")return{type:"str",data:new TextEncoder("utf-8").encode(e)};if(Array.isArray(e))return{type:"list",items:await Promise.all(e.map(v.pack))};if(typeof e=="object"){let t=Object.keys(e),s=[];for(let o in e)s.push(v.pack(e[o]));let i=await Promise.all(s),n={};for(let o=0;o<t.length;o++)n[t[o]]=i[o];return{type:"dict",props:n}}else throw new Error("Unsupported datum type: ${typeof datum} (${datum.constructor.name})")}static async unpack(e){return new Promise((t,s)=>{switch(e.type){case"null":return t(null);case"int":case"float":case"bool":return t(e.data);case"bytes":return t(e.data.buffer);case"str":let i=new TextDecoder("utf-8");return t(i.decode(e.data));case"list":return Promise.all(e.items.map(v.unpack)).then(t).catch(s);case"dict":let n=[],o=[];for(let k in e.props)n.push(k),o.push(v.unpack(e.props[k]));return Promise.all(o).then(k=>{let L={};for(let E=0;E<n.length;E++)L[n[E]]=k[E];t(L)}).catch(s);case"ndarray":case"tensor":return t(new b(e.data,e.shape,e.dtype));case"image":if(typeof Image>"u")return s(new Error("Image is not supported in this environment."));const a=new Blob([e.data],{type:`image/${e.dtype}`}),h=URL.createObjectURL(a),f=new Image;return f.addEventListener("load",()=>{t(f)}),f.src=h,f;case"audio":const w=new Blob([e.data],{type:`audio/${e.dtype}`}),u=URL.createObjectURL(w),g=new Audio;return g.addEventListener("loadeddata",()=>{t(g)}),g.src=u,g;case"exception":let l=new TextDecoder("utf-8").decode(e.data);return t(new Error(`${e.dtype}: ${l}`));default:console.error("Unhandled response type",e),s(new Error(`Unsupported packed type: ${e.type}`))}})}static async encode(e){let t=await v.pack(e);return dt(t)}static async decode(e){let t=Ut(e);return await v.unpack(t)}}class Le{constructor(){this.holder=Promise.resolve()}acquire(){let e,t=new Promise(i=>{e=()=>i()}),s=this.holder.then(()=>e);return this.holder=t,s}}function*At(r,e){for(let t=0;t<r.length;t+=e)yield r.slice(t,t+e)}const St=1024*1024;class Bt{constructor(e,t=!1){this.socket=null,this.address=e,this.lock=new Le,this.debug=t,this.messageLength=null,this.messageBuffer=[],this.messageListeners=[],this.errorListeners=[]}get isWebsocket(){return this.address.startsWith("ws://")||this.address.startsWith("wss://")}get isSecure(){return this.address.startsWith("wss://")||this.address.startsWith("https://")||!this.hasProtocol&&window!==void 0&&window.location.protocol==="https:"}get hasProtocol(){return this.addressHasProtocol(this.address)}get host(){return this.hasProtocol?new URL(this.address).host:window!==void 0&&window.location!==void 0?window.location.host:null}get address(){return this.url}set address(e){this.url=e,!(this.socket&&this.socket.url===e)&&this.close()}addressHasProtocol(e){return/^[a-z]+:\/\//.test(e)}getWebsocket(){return new Promise((e,t)=>{this.lock.acquire().then(s=>{try{if(this.socket!==null&&this.socket!==void 0)if(this.socket.readyState===WebSocket.OPEN){e(this.socket);return}else this.socket.readyState!==WebSocket.CONNECTING&&this.close();if(this.socket===null||this.socket===void 0)this.socket=new WebSocket(this.address),this.socket.binaryType="arraybuffer",this.socket.addEventListener("open",()=>{e(this.socket)}),this.socket.addEventListener("message",async i=>{await this.pushMessageChunk(i.data)}),this.socket.addEventListener("error",i=>{this.dispatchError(i)});else throw new Error(`WebSocket connection is in state ${this.socket.readyState}.`)}catch(i){if(console.error("Error getting WebSocket connection:",i),this.socket!==null&&this.socket!==void 0){try{this.socket.close()}catch{}delete this.socket}this.dispatchError(i),t(i)}finally{s()}})})}close(){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.lock.acquire().then(e=>{this.socket.close(),delete this.socket,e()})}async pushMessageChunk(e){this.messageLength===null&&e.byteLength>=4&&(this.messageLength=new DataView(e).getUint32(0),e=e.slice(4)),this.messageBuffer.push(new Uint8Array(e));let t=this.messageBuffer.reduce((s,i)=>s+i.byteLength,0);this.messageLength!==null&&t>=this.messageLength&&(this.messageBuffer.length===1?this.dispatchMessage(await v.decode(this.messageBuffer[0])):this.dispatchMessage(await v.decode(de(this.messageBuffer))),this.messageLength=null,this.messageBuffer=[])}onMessage(e){this.messageListeners.push(e)}onError(e){this.errorListeners.push(e)}offMessage(e){this.messageListeners=this.messageListeners.filter(t=>t!==e)}offError(e){this.errorListeners=this.errorListeners.filter(t=>t!==e)}dispatchMessage(e){this.debug&&console.log("Received message:",e),this.messageListeners.forEach(t=>t(e))}dispatchError(e){this.debug&&console.error("Received error:",e),this.errorListeners.forEach(t=>t(e))}send(e,t=!0){return this.debug&&console.log("Sending message:",e,"to",this.address),new Promise(async(s,i)=>{try{if(this.isWebsocket){let[n,o]=await Promise.all([this.getWebsocket(),v.encode(e)]);if(t){let f=u=>{s(u),this.offMessage(f)},w=u=>{i(u),this.offError(w)};this.onMessage(f),this.onError(w)}let a=new Uint8Array(new ArrayBuffer(4)),h=!1;new DataView(a.buffer).setUint32(0,o.length);for(let f of At(o,St))h?await n.send(f):(await n.send(de([a,f])),h=!0);t||s()}else{let n=await v.encode(e),o=await fetch(this.address,{method:"POST",body:n,headers:{"Content-Type":"application/octet-stream"}});if(o.ok){let a=await o.arrayBuffer(),h=await v.decode(new Uint8Array(a));this.dispatchMessage(h),s(h)}else{let a=new Error(`Error sending message: ${o.statusText}`);this.dispatchError(a),i(a)}}}catch(n){i(n)}})}}class ge extends Bt{send(e,t=!0){if(typeof e=="string")return super.send(e,t);if(!e instanceof Object)throw new Error("Message must be an object.");let s;if(e.request!==void 0&&e.request!==null&&e.request.id!==void 0)s=e.request.id;else if(e.id!==void 0)s=e.id;else throw new Error("Message must have an ID.");return t?new Promise((i,n)=>{let o=h=>{h instanceof Error?n(h):h.id===s&&(i(h),this.offMessage(o))},a=h=>{n(h),this.offError(a),this.offMessage(o)};this.onMessage(o),this.onError(a),super.send(e,!1)}):super.send(e,!1)}}class vt{constructor(e){this.driver=e,this.scopes={}}getScope(e,t){return this.scopes.hasOwnProperty(e)||(this.scopes[e]=new Tt(e,this.driver,t)),this.scopes[e]}getAll(){return Object.getOwnPropertyNames(this.scopes).reduce((e,t)=>(e[t]=storage.getScope(t).getAll(),e),{})}clear(){for(let e in this.scopes)this.getScope(e).clear()}}class Tt{constructor(e,t,s){this.scope=e,this.driver=t,this.ttl=s,this.ttl===void 0&&(this.ttl=60*60*1e3)}getAll(){return this.keys().reduce((e,t)=>(e[t]=storage.getItem(t),e),{})}setItem(e,t){let s=`${this.scope}-${e}`,i=`${this.scope}-${e}-expiration`;this.driver.setItem(s,JSON.stringify(t)),this.driver.setItem(i,new Date().getTime()+this.ttl)}getItem(e){let t=`${this.scope}-${e}`,s=`${this.scope}-${e}-expiration`,i=this.driver.getItem(t),n=this.driver.getItem(s);if(!(i===void 0||i==="undefined"))return i===null||i==="null"?null:(i=JSON.parse(i),!V(n)&&n<=new Date().getTime()?(this.removeItem(t),null):i)}keys(){let e=`${this.scope}-`,t;return this.driver.keys!==void 0?t=this.driver.keys():t=Object.getOwnPropertyNames(this.driver),t.filter(s=>s.startsWith(e)).map(s=>s.substring(e.length)).filter(s=>s!="expiration")}removeItem(e){let t=`${this.scope}-${e}`;return this.driver.removeItem(t)}removePrefix(e){for(let t of this.keys())t.startsWith(e)&&this.removeItem(t)}clear(){for(let e of this.keys())this.removeItem(e);return this.setItem("expiration",{}),this.driver.clear()}key(e){return this.keys()[e]}}class ye{constructor(){this.expiration=new Date,this.expiration.setTime(this.expiration.getTime()+30*24*60*60*1e3)}keys(){let e=decodeURIComponent(document.cookie).split(";"),t,s=[];for(let i of e){for(t=i.split("=")[0];t.charAt(0)==" ";)t=t.substring(1);s.push(t)}return s}getItem(e){let t=decodeURIComponent(document.cookie).split(";");for(let s of t){for(;s.charAt(0)==" ";)s=s.substring(1);if(s.startsWith(`${e}=`))return JSON.parse(s.substring(e.length+1))}return null}setItem(e,t,s){s===void 0&&(s=this.expiration),document.cookie=[`${e}=${JSON.stringify(t)}`,`expires=${s.toUTCString()}`,"path=/",""].join(";")}removeItem(e){let t=new Date;t.setTime(0),this.setItem(e,"",t)}clear(){for(let e of this.keys())this.removeItem(e)}key(e){return this.keys()[e]}}class Lt{constructor(){this.storage={}}keys(){return Object.getOwnPropertyNames(this.storage)}setItem(e,t){this.storage[e]=t}getItem(e){return this.storage.hasOwnProperty(e)?this.storage[e]:null}removeItem(e){delete this.storage[e]}removePrefix(e){for(let t of this.keys())t.startsWith(e)&&this.removeItem(t)}clear(){for(let e of this.keys)delete this.storage[e]}key(e){return this.keys()[e]}}let Mt=function(){try{return typeof localStorage<"u"?localStorage:typeof window<"u"?new ye:new Lt}catch(r){return console.error("Couldn't get local storage, defaulting to cookies.",r),new ye}},Pt=new vt(Mt());const pe=Pt.getScope("taproot");function ie(r=null){if(r==null)return{type:"NoneType"};let e={parameter_type:r.constructor,parameter_size:1};if(typeof Blob<"u"&&r instanceof Blob)e.parameter_type="bytes",e.parameter_size=r.size;else if(r instanceof b)e.parameter_size=r.shape;else if(b.isTypedArray(r))r=new b(r),e.parameter_type=b,e.parameter_size=r.shape;else if(typeof Image<"u"&&r instanceof Image)e.parameter_size=[r.width,r.height];else if(Array.isArray(r))e.parameter_size=[r.length],e.parameter_sub_metadata=ie(r[0]);else if(e.parameter_type===Object){e.parameter_size=Object.keys(r).length,e.parameter_sub_metadata={};for(let t in r)e.parameter_sub_metadata[t]=ie(r[t])}else r.length!==void 0&&(e.parameter_size=r.length);return e}function $t(r){let e={};for(let t in r)e[t]=ie(r[t]);return e}class Me extends ge{get completeAddress(){if(this.hasProtocol)return this.address;if(typeof window<"u"&&window.location!==void 0){let e=window.location.href;if(this.isWebsocket&&(e=e.replace("http://","ws://").replace("https://","wss://")),!e.endsWith("/"))if(window.location.href===window.location.origin)e+="/";else{let t=e.lastIndexOf("/");e=e.substring(0,t+1)}return this.address.startsWith("/")?`${e}${this.address.substring(1)}`:`${e}${this.address}`}return this.address}get clientId(){let e=pe.getItem("clientId");if(e)return e;let t=fe();return pe.setItem("clientId",t),t}getClient(e){return(this.executors===null||this.executors===void 0)&&(this.executors={}),this.isWebsocket&&!this.addressHasProtocol(e)&&(e.startsWith("/")&&(e=e.substring(1)),this.host!==null?this.isSecure?e=`wss://${this.host}/${e}`:e=`ws://${this.host}/${e}`:this.isSecure?e=`wss://${e}`:e=`ws://${e}`),(this.executors[e]===null||this.executors[e]===void 0)&&(this.debug&&console.log(`Creating new client for ${e}`),this.executors[e]=new ge(e,this.debug)),this.executors[e]}clearClientForTask(e,t=null){(this.tasks===null||this.tasks===void 0)&&(this.tasks={}),(this.tasks[e]===null||this.tasks[e]===void 0)&&(this.tasks[e]={}),t==null&&(t="default"),this.tasks[e][t]!==null&&this.tasks[e][t]!==void 0&&this.tasks[e][t].close(),this.tasks[e][t]=null}setClientForTask(e,t,s=null){(this.tasks===null||this.tasks===void 0)&&(this.tasks={}),(this.tasks[t]===null||this.tasks[t]===void 0)&&(this.tasks[t]={}),s==null&&(s="default"),this.tasks[t][s]=e}getClientForTask(e,t=null){return(this.tasks===null||this.tasks===void 0)&&(this.tasks={}),(this.tasks[e]===null||this.tasks[e]===void 0)&&(this.tasks[e]={}),t==null&&(t="default"),this.tasks[e][t]!==null&&this.tasks[e][t]!==void 0?this.tasks[e][t]:null}getLockForTask(e,t=null){return(this.locks===null||this.locks===void 0)&&(this.locks={}),(this.locks[e]===null||this.locks[e]===void 0)&&(this.locks[e]={}),t==null&&(t="default"),(this.locks[e][t]===null||this.locks[e][t]===void 0)&&(this.locks[e][t]=new Le),this.locks[e][t]}sendInvocation(e,t){t=t||{};let s=e.task,i=e.model||null,n=e.continuation,o=0,a=t.fetchIntermediates,h=t.pollingInterval||1e3,f=t.retryDelay||20,w=t.onIntermediateResult||((g,y)=>console.log("Ignored intermediate result",y,g)),u=t.onInterimResult||((g,y)=>console.log("Ignored interim result",y,g));if(V(s))throw new Error("Task is required.");return new Promise((g,y)=>{e.id=fe(),e.client_id=this.clientId,e.overseer=this.completeAddress,e.return_metadata=!0,e.wait_for_result=!a;let l=this.getClientForTask(s,i),k=(c,I=3)=>new Promise((p,m)=>{let x=c.id,F=c.address,U=this.getClient(F),W=()=>U.send({id:x,client_id:this.clientId,return_metadata:!0,wait_for_result:!a}),M=d=>{U.offError(M),U.offMessage(P),retry?k(c,!1).then(p).catch(m):(console.error("Error with continuation",x,"from",F,d),m(d))},P=d=>{if(d instanceof Error)U.offMessage(P),U.offError(M),I>0?setTimeout(()=>{k(c,I-1).then(p).catch(m)},f):(console.error("Error with continuation",x,"from",F,d),m(d));else if(d.id==x)if(["error","complete"].includes(d.status))if(U.offMessage(P),U.offError(M),d.status==="error")m(d.result);else if(d.continuation){u(d.result,o),o++;let $=d.continuation,O=!1;Array.isArray($)||($=[$],O=!0);let R=[];for(let C of $)R.push(k(C));Promise.all(R).then(C=>{p(O?C[0]:C)}).catch(m)}else p(d.result);else V(d.intermediate)||w(d.intermediate,o),setTimeout(W,h)};U.onMessage(P),U.onError(M),W()}),L=()=>l.send({id:e.id,client_id:this.clientId,return_metadata:!0,wait_for_result:!a}),E=c=>{if(c.id===e.id)if(["error","complete"].includes(c.status))if(l.offMessage(E),l.offError(D),n)if(u(c.result,o),o++,!c.continuation||!c.continuation.id)y("Continuation request but not found in message");else{let I=c.continuation,p=!1;Array.isArray(I)||(I=[I],p=!0);let m=[];for(let x of I)m.push(k(x));Promise.all(m).then(x=>{g(p?x[0]:x)}).catch(y)}else g(c.result);else V(c.intermediate)||w(c.intermediate,o),setTimeout(L,h)},D=c=>{l.offMessage(E),l.offError(D),y(c)},z=e.parameters;if(l===null)e.parameters=$t(z),this.send(e).then(c=>{if(c.address){if(c.address.startsWith("tcp://")||c.address.startsWith("tcps://")||c.address.startsWith("unix://")){y(`Executor is not configured for websocket or HTTP communication, received: ${c.address}`);return}}else{y("No address found for executor.");return}e.parameters=z,l=this.getClient(c.address),l.onMessage(E),l.onError(D),l.send(e,!1),this.setClientForTask(l,s,i)}).catch(y);else{this.debug&&console.log("Reusing client for task",s);let c=I=>{l.offMessage(E),l.offError(c),this.clearClientForTask(s,i),this.sendInvocation(e,t).then(p=>{g(p)}).catch(p=>{y(p)})};e.parameters=z,l.onMessage(E),l.onError(c),l.send(e,!1)}})}invoke(e,t){let s=e.task,i=e.model||null;if(V(s))throw new Error("Task is required.");return new Promise((n,o)=>{this.getLockForTask(s,i).acquire().then(a=>this.sendInvocation(e,t).then(h=>{a(),n(h)}).catch(h=>{a(),o(h)}))})}close(){for(let e in this.tasks)for(let t in this.tasks[e])this.clearClientForTask(e,t);super.close()}}typeof window<"u"&&(window.Taproot=Me);const Ct=document.getElementById("prompt"),Dt=document.getElementById("canvas"),zt=new Me("ws://127.0.0.1:5000");let we="",Ft=Dt.getContext("2d");const Wt=r=>new Promise(async(e,t)=>{let s=await zt.invoke({task:"image-generation",model:"stable-diffusion-xl-turbo",parameters:{prompt:`RAW photo, ${r}, high resolution, best quality, shot with Fujifilm XT3, shot with Nikon D3, professional photography`,output_format:"jpeg",seed:45894897,num_inference_steps:2}});e(),Ft.drawImage(s,0,0)}),Pe=async()=>{let r=Ct.value;r.length===0&&(r="a cat wearing a hat"),r!==we&&(await Wt(r),we=r),setTimeout(Pe,1)};Pe();(function(){const r=document.createElement("link").relList;if(r&&r.supports&&r.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))t(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const n of i.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&t(n)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function t(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();let q=r=>r==null||r===""||r==="null"||Array.isArray(r)&&r.length===0||typeof r=="object"&&r.constructor.name==="Object"&&Object.getOwnPropertyNames(r).length===0,me=()=>"10000000-1000-4000-8000-100000000000".replace(/[018]/g,r=>(+r^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+r/4).toString(16)),xe=r=>{let e=r.reduce((i,n)=>i+n.length,0),t=new r[0].constructor(e),s=0;return r.forEach(i=>{t.set(i,s),s+=i.length}),t};class A{constructor(e,t=null,s=null){if(e instanceof A)this.data=e.data,this.shape=e.shape,this.dtype=e.dtype;else if(A.isTypedArray(e)){let i=A.getDataTypeFromTypedArray(e);s!==null&&i!==s?(this.data=new(A.getArrayConstructorFromDataType(s))(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)),this.dtype=s):(this.data=e,this.dtype=i),t===null&&(t=[e.length]),this.shape=t}else if(s!==null)this.data=new(A.getArrayConstructorFromDataType(s))(e),t===null&&(t=[e.length]),this.shape=t,this.dtype=s;else if(Array.isArray(e))this.data=new Int32Array(e),this.shape=[e.length],this.dtype="int32";else throw new Error(`Invalid data type ${typeof e} (${e.constructor.name})`)}get(){let e=Array.from(arguments);if(e.length!==this.shape.length)throw new Error("Incorrect number of indexes");let t=0;for(let s=0;s<e.length;s++)t+=e[s]*this.strides[s];return this.data[t]}set(){let e=Array.from(arguments),t=e.pop();if(e.length!==this.shape.length)throw new Error("Incorrect number of indexes");let s=0;for(let i=0;i<e.length;i++)s+=e[i]*this.strides[i];this.data[s]=t}get packed(){return{type:"ndarray",shape:this.shape,dtype:this.dtype,data:this.data}}get imageData(){if(this.shape.length!==3)throw new Error("Can only get ImageData from 3D array (height, width, channels)");let[e,t,s]=this.shape;if(s===3){let i=new Uint8ClampedArray(t*e*4);for(let n=0;n<t*e;n++)i[n*4]=this.data[n*3],i[n*4+1]=this.data[n*3+1],i[n*4+2]=this.data[n*3+2],i[n*4+3]=255;return new ImageData(i,t,e)}return new ImageData(new Uint8ClampedArray(this.data.buffer.slice(this.data.byteOffset,this.data.byteOffset+this.data.byteLength)),t,e)}static getDataTypeFromTypedArray(e){if(A.isTypedArray(e))return e.constructor.name.replace("Array","").toLowerCase();throw new Error(`Not a typed array: ${e.constructor.name}`)}static getArrayConstructorFromDataType(e){switch(e){case"float32":return Float32Array;case"float64":return Float64Array;case"int8":return Int8Array;case"int16":return Int16Array;case"int32":return Int32Array;case"uint8":return Uint8Array;case"uint16":return Uint16Array;case"uint32":return Uint32Array;default:throw new Error(`Unknown data type: ${e}`)}}static isTypedArray(e){return e instanceof Float32Array||e instanceof Float64Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array}toString(){return`NDArray(${this.data}, ${this.shape}, ${this.dtype})`}}function Ot(r){const e=r.length;let t=0,s=0;for(;s<e;){let i=r.charCodeAt(s++);if((i&4294967168)===0){t++;continue}else if((i&4294965248)===0)t+=2;else{if(i>=55296&&i<=56319&&s<e){const n=r.charCodeAt(s);(n&64512)===56320&&(++s,i=((i&1023)<<10)+(n&1023)+65536)}(i&4294901760)===0?t+=3:t+=4}}return t}function Rt(r,e,t){const s=r.length;let i=t,n=0;for(;n<s;){let o=r.charCodeAt(n++);if((o&4294967168)===0){e[i++]=o;continue}else if((o&4294965248)===0)e[i++]=o>>6&31|192;else{if(o>=55296&&o<=56319&&n<s){const a=r.charCodeAt(n);(a&64512)===56320&&(++n,o=((o&1023)<<10)+(a&1023)+65536)}(o&4294901760)===0?(e[i++]=o>>12&15|224,e[i++]=o>>6&63|128):(e[i++]=o>>18&7|240,e[i++]=o>>12&63|128,e[i++]=o>>6&63|128)}e[i++]=o&63|128}}const _t=new TextEncoder,Nt=50;function Ht(r,e,t){_t.encodeInto(r,e.subarray(t))}function Kt(r,e,t){r.length>Nt?Ht(r,e,t):Rt(r,e,t)}const Vt=4096;function $e(r,e,t){let s=e;const i=s+t,n=[];let o="";for(;s<i;){const a=r[s++];if((a&128)===0)n.push(a);else if((a&224)===192){const h=r[s++]&63;n.push((a&31)<<6|h)}else if((a&240)===224){const h=r[s++]&63,f=r[s++]&63;n.push((a&31)<<12|h<<6|f)}else if((a&248)===240){const h=r[s++]&63,f=r[s++]&63,w=r[s++]&63;let u=(a&7)<<18|h<<12|f<<6|w;u>65535&&(u-=65536,n.push(u>>>10&1023|55296),u=56320|u&1023),n.push(u)}else n.push(a);n.length>=Vt&&(o+=String.fromCharCode(...n),n.length=0)}return n.length>0&&(o+=String.fromCharCode(...n)),o}const qt=new TextDecoder,Jt=200;function Xt(r,e,t){const s=r.subarray(e,e+t);return qt.decode(s)}function Yt(r,e,t){return t>Jt?Xt(r,e,t):$e(r,e,t)}class G{constructor(e,t){this.type=e,this.data=t}}class B extends Error{constructor(e){super(e);const t=Object.create(B.prototype);Object.setPrototypeOf(this,t),Object.defineProperty(this,"name",{configurable:!0,enumerable:!1,value:B.name})}}const H=4294967295;function Gt(r,e,t){const s=t/4294967296,i=t;r.setUint32(e,s),r.setUint32(e+4,i)}function Ce(r,e,t){const s=Math.floor(t/4294967296),i=t;r.setUint32(e,s),r.setUint32(e+4,i)}function De(r,e){const t=r.getInt32(e),s=r.getUint32(e+4);return t*4294967296+s}function Zt(r,e){const t=r.getUint32(e),s=r.getUint32(e+4);return t*4294967296+s}const Qt=-1,jt=4294967296-1,es=17179869184-1;function ts({sec:r,nsec:e}){if(r>=0&&e>=0&&r<=es)if(e===0&&r<=jt){const t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,r),t}else{const t=r/4294967296,s=r&4294967295,i=new Uint8Array(8),n=new DataView(i.buffer);return n.setUint32(0,e<<2|t&3),n.setUint32(4,s),i}else{const t=new Uint8Array(12),s=new DataView(t.buffer);return s.setUint32(0,e),Ce(s,4,r),t}}function ss(r){const e=r.getTime(),t=Math.floor(e/1e3),s=(e-t*1e3)*1e6,i=Math.floor(s/1e9);return{sec:t+i,nsec:s-i*1e9}}function is(r){if(r instanceof Date){const e=ss(r);return ts(e)}else return null}function rs(r){const e=new DataView(r.buffer,r.byteOffset,r.byteLength);switch(r.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:{const t=e.getUint32(0),s=e.getUint32(4),i=(t&3)*4294967296+s,n=t>>>2;return{sec:i,nsec:n}}case 12:{const t=De(e,4),s=e.getUint32(0);return{sec:t,nsec:s}}default:throw new B(`Unrecognized data size for timestamp (expected 4, 8, or 12): ${r.length}`)}}function ns(r){const e=rs(r);return new Date(e.sec*1e3+e.nsec/1e6)}const os={type:Qt,encode:is,decode:ns};class Q{constructor(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(os)}register({type:e,encode:t,decode:s}){if(e>=0)this.encoders[e]=t,this.decoders[e]=s;else{const i=-1-e;this.builtInEncoders[i]=t,this.builtInDecoders[i]=s}}tryToEncode(e,t){for(let s=0;s<this.builtInEncoders.length;s++){const i=this.builtInEncoders[s];if(i!=null){const n=i(e,t);if(n!=null){const o=-1-s;return new G(o,n)}}}for(let s=0;s<this.encoders.length;s++){const i=this.encoders[s];if(i!=null){const n=i(e,t);if(n!=null){const o=s;return new G(o,n)}}}return e instanceof G?e:null}decode(e,t,s){const i=t<0?this.builtInDecoders[-1-t]:this.decoders[t];return i?i(e,t,s):new G(t,e)}}Q.defaultCodec=new Q;function as(r){return r instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&r instanceof SharedArrayBuffer}function re(r){return r instanceof Uint8Array?r:ArrayBuffer.isView(r)?new Uint8Array(r.buffer,r.byteOffset,r.byteLength):as(r)?new Uint8Array(r):Uint8Array.from(r)}const hs=100,cs=2048;let ls=class ze{constructor(e){this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Q.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.maxDepth=(e==null?void 0:e.maxDepth)??hs,this.initialBufferSize=(e==null?void 0:e.initialBufferSize)??cs,this.sortKeys=(e==null?void 0:e.sortKeys)??!1,this.forceFloat32=(e==null?void 0:e.forceFloat32)??!1,this.ignoreUndefined=(e==null?void 0:e.ignoreUndefined)??!1,this.forceIntegerToFloat=(e==null?void 0:e.forceIntegerToFloat)??!1,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}clone(){return new ze({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,maxDepth:this.maxDepth,initialBufferSize:this.initialBufferSize,sortKeys:this.sortKeys,forceFloat32:this.forceFloat32,ignoreUndefined:this.ignoreUndefined,forceIntegerToFloat:this.forceIntegerToFloat})}reinitializeState(){this.pos=0}encodeSharedRef(e){if(this.entered)return this.clone().encodeSharedRef(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.subarray(0,this.pos)}finally{this.entered=!1}}encode(e){if(this.entered)return this.clone().encode(e);try{return this.entered=!0,this.reinitializeState(),this.doEncode(e,1),this.bytes.slice(0,this.pos)}finally{this.entered=!1}}doEncode(e,t){if(t>this.maxDepth)throw new Error(`Too deep objects in depth ${t}`);e==null?this.encodeNil():typeof e=="boolean"?this.encodeBoolean(e):typeof e=="number"?this.forceIntegerToFloat?this.encodeNumberAsFloat(e):this.encodeNumber(e):typeof e=="string"?this.encodeString(e):this.useBigInt64&&typeof e=="bigint"?this.encodeBigInt64(e):this.encodeObject(e,t)}ensureBufferSizeToWrite(e){const t=this.pos+e;this.view.byteLength<t&&this.resizeBuffer(t*2)}resizeBuffer(e){const t=new ArrayBuffer(e),s=new Uint8Array(t),i=new DataView(t);s.set(this.bytes),this.view=i,this.bytes=s}encodeNil(){this.writeU8(192)}encodeBoolean(e){e===!1?this.writeU8(194):this.writeU8(195)}encodeNumber(e){!this.forceIntegerToFloat&&Number.isSafeInteger(e)?e>=0?e<128?this.writeU8(e):e<256?(this.writeU8(204),this.writeU8(e)):e<65536?(this.writeU8(205),this.writeU16(e)):e<4294967296?(this.writeU8(206),this.writeU32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(207),this.writeU64(e)):e>=-32?this.writeU8(224|e+32):e>=-128?(this.writeU8(208),this.writeI8(e)):e>=-32768?(this.writeU8(209),this.writeI16(e)):e>=-2147483648?(this.writeU8(210),this.writeI32(e)):this.useBigInt64?this.encodeNumberAsFloat(e):(this.writeU8(211),this.writeI64(e)):this.encodeNumberAsFloat(e)}encodeNumberAsFloat(e){this.forceFloat32?(this.writeU8(202),this.writeF32(e)):(this.writeU8(203),this.writeF64(e))}encodeBigInt64(e){e>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(e)):(this.writeU8(211),this.writeBigInt64(e))}writeStringHeader(e){if(e<32)this.writeU8(160+e);else if(e<256)this.writeU8(217),this.writeU8(e);else if(e<65536)this.writeU8(218),this.writeU16(e);else if(e<4294967296)this.writeU8(219),this.writeU32(e);else throw new Error(`Too long string: ${e} bytes in UTF-8`)}encodeString(e){const t=Ot(e);this.ensureBufferSizeToWrite(5+t),this.writeStringHeader(t),Kt(e,this.bytes,this.pos),this.pos+=t}encodeObject(e,t){const s=this.extensionCodec.tryToEncode(e,this.context);if(s!=null)this.encodeExtension(s);else if(Array.isArray(e))this.encodeArray(e,t);else if(ArrayBuffer.isView(e))this.encodeBinary(e);else if(typeof e=="object")this.encodeMap(e,t);else throw new Error(`Unrecognized object: ${Object.prototype.toString.apply(e)}`)}encodeBinary(e){const t=e.byteLength;if(t<256)this.writeU8(196),this.writeU8(t);else if(t<65536)this.writeU8(197),this.writeU16(t);else if(t<4294967296)this.writeU8(198),this.writeU32(t);else throw new Error(`Too large binary: ${t}`);const s=re(e);this.writeU8a(s)}encodeArray(e,t){const s=e.length;if(s<16)this.writeU8(144+s);else if(s<65536)this.writeU8(220),this.writeU16(s);else if(s<4294967296)this.writeU8(221),this.writeU32(s);else throw new Error(`Too large array: ${s}`);for(const i of e)this.doEncode(i,t+1)}countWithoutUndefined(e,t){let s=0;for(const i of t)e[i]!==void 0&&s++;return s}encodeMap(e,t){const s=Object.keys(e);this.sortKeys&&s.sort();const i=this.ignoreUndefined?this.countWithoutUndefined(e,s):s.length;if(i<16)this.writeU8(128+i);else if(i<65536)this.writeU8(222),this.writeU16(i);else if(i<4294967296)this.writeU8(223),this.writeU32(i);else throw new Error(`Too large map object: ${i}`);for(const n of s){const o=e[n];this.ignoreUndefined&&o===void 0||(this.encodeString(n),this.doEncode(o,t+1))}}encodeExtension(e){if(typeof e.data=="function"){const s=e.data(this.pos+6),i=s.length;if(i>=4294967296)throw new Error(`Too large extension object: ${i}`);this.writeU8(201),this.writeU32(i),this.writeI8(e.type),this.writeU8a(s);return}const t=e.data.length;if(t===1)this.writeU8(212);else if(t===2)this.writeU8(213);else if(t===4)this.writeU8(214);else if(t===8)this.writeU8(215);else if(t===16)this.writeU8(216);else if(t<256)this.writeU8(199),this.writeU8(t);else if(t<65536)this.writeU8(200),this.writeU16(t);else if(t<4294967296)this.writeU8(201),this.writeU32(t);else throw new Error(`Too large extension object: ${t}`);this.writeI8(e.type),this.writeU8a(e.data)}writeU8(e){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,e),this.pos++}writeU8a(e){const t=e.length;this.ensureBufferSizeToWrite(t),this.bytes.set(e,this.pos),this.pos+=t}writeI8(e){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,e),this.pos++}writeU16(e){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,e),this.pos+=2}writeI16(e){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,e),this.pos+=2}writeU32(e){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,e),this.pos+=4}writeI32(e){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,e),this.pos+=4}writeF32(e){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,e),this.pos+=4}writeF64(e){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,e),this.pos+=8}writeU64(e){this.ensureBufferSizeToWrite(8),Gt(this.view,this.pos,e),this.pos+=8}writeI64(e){this.ensureBufferSizeToWrite(8),Ce(this.view,this.pos,e),this.pos+=8}writeBigUint64(e){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,e),this.pos+=8}writeBigInt64(e){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,e),this.pos+=8}};function fs(r,e){return new ls(e).encodeSharedRef(r)}function ee(r){return`${r<0?"-":""}0x${Math.abs(r).toString(16).padStart(2,"0")}`}const ds=16,us=16;class gs{constructor(e=ds,t=us){this.hit=0,this.miss=0,this.maxKeyLength=e,this.maxLengthPerKey=t,this.caches=[];for(let s=0;s<this.maxKeyLength;s++)this.caches.push([])}canBeCached(e){return e>0&&e<=this.maxKeyLength}find(e,t,s){const i=this.caches[s-1];e:for(const n of i){const o=n.bytes;for(let a=0;a<s;a++)if(o[a]!==e[t+a])continue e;return n.str}return null}store(e,t){const s=this.caches[e.length-1],i={bytes:e,str:t};s.length>=this.maxLengthPerKey?s[Math.random()*s.length|0]=i:s.push(i)}decode(e,t,s){const i=this.find(e,t,s);if(i!=null)return this.hit++,i;this.miss++;const n=$e(e,t,s),o=Uint8Array.prototype.slice.call(e,t,t+s);return this.store(o,n),n}}const ne="array",X="map_key",Fe="map_value",ys=r=>{if(typeof r=="string"||typeof r=="number")return r;throw new B("The type of key must be string or number but "+typeof r)};class ps{constructor(){this.stack=[],this.stackHeadPosition=-1}get length(){return this.stackHeadPosition+1}top(){return this.stack[this.stackHeadPosition]}pushArrayState(e){const t=this.getUninitializedStateFromPool();t.type=ne,t.position=0,t.size=e,t.array=new Array(e)}pushMapState(e){const t=this.getUninitializedStateFromPool();t.type=X,t.readCount=0,t.size=e,t.map={}}getUninitializedStateFromPool(){if(this.stackHeadPosition++,this.stackHeadPosition===this.stack.length){const e={type:void 0,size:0,array:void 0,position:0,readCount:0,map:void 0,key:null};this.stack.push(e)}return this.stack[this.stackHeadPosition]}release(e){if(this.stack[this.stackHeadPosition]!==e)throw new Error("Invalid stack state. Released state is not on top of the stack.");if(e.type===ne){const t=e;t.size=0,t.array=void 0,t.position=0,t.type=void 0}if(e.type===X||e.type===Fe){const t=e;t.size=0,t.map=void 0,t.readCount=0,t.type=void 0}this.stackHeadPosition--}reset(){this.stack.length=0,this.stackHeadPosition=-1}}const K=-1,ce=new DataView(new ArrayBuffer(0)),ws=new Uint8Array(ce.buffer);try{ce.getInt8(0)}catch(r){if(!(r instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}const Ue=new RangeError("Insufficient data"),ms=new gs;class le{constructor(e){this.totalPos=0,this.pos=0,this.view=ce,this.bytes=ws,this.headByte=K,this.stack=new ps,this.entered=!1,this.extensionCodec=(e==null?void 0:e.extensionCodec)??Q.defaultCodec,this.context=e==null?void 0:e.context,this.useBigInt64=(e==null?void 0:e.useBigInt64)??!1,this.rawStrings=(e==null?void 0:e.rawStrings)??!1,this.maxStrLength=(e==null?void 0:e.maxStrLength)??H,this.maxBinLength=(e==null?void 0:e.maxBinLength)??H,this.maxArrayLength=(e==null?void 0:e.maxArrayLength)??H,this.maxMapLength=(e==null?void 0:e.maxMapLength)??H,this.maxExtLength=(e==null?void 0:e.maxExtLength)??H,this.keyDecoder=(e==null?void 0:e.keyDecoder)!==void 0?e.keyDecoder:ms,this.mapKeyConverter=(e==null?void 0:e.mapKeyConverter)??ys}clone(){return new le({extensionCodec:this.extensionCodec,context:this.context,useBigInt64:this.useBigInt64,rawStrings:this.rawStrings,maxStrLength:this.maxStrLength,maxBinLength:this.maxBinLength,maxArrayLength:this.maxArrayLength,maxMapLength:this.maxMapLength,maxExtLength:this.maxExtLength,keyDecoder:this.keyDecoder})}reinitializeState(){this.totalPos=0,this.headByte=K,this.stack.reset()}setBuffer(e){const t=re(e);this.bytes=t,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength),this.pos=0}appendBuffer(e){if(this.headByte===K&&!this.hasRemaining(1))this.setBuffer(e);else{const t=this.bytes.subarray(this.pos),s=re(e),i=new Uint8Array(t.length+s.length);i.set(t),i.set(s,t.length),this.setBuffer(i)}}hasRemaining(e){return this.view.byteLength-this.pos>=e}createExtraByteError(e){const{view:t,pos:s}=this;return new RangeError(`Extra ${t.byteLength-s} of ${t.byteLength} byte(s) found at buffer[${e}]`)}decode(e){if(this.entered)return this.clone().decode(e);try{this.entered=!0,this.reinitializeState(),this.setBuffer(e);const t=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return t}finally{this.entered=!1}}*decodeMulti(e){if(this.entered){yield*this.clone().decodeMulti(e);return}try{for(this.entered=!0,this.reinitializeState(),this.setBuffer(e);this.hasRemaining(1);)yield this.doDecodeSync()}finally{this.entered=!1}}async decodeAsync(e){if(this.entered)return this.clone().decodeAsync(e);try{this.entered=!0;let t=!1,s;for await(const a of e){if(t)throw this.entered=!1,this.createExtraByteError(this.totalPos);this.appendBuffer(a);try{s=this.doDecodeSync(),t=!0}catch(h){if(!(h instanceof RangeError))throw h}this.totalPos+=this.pos}if(t){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return s}const{headByte:i,pos:n,totalPos:o}=this;throw new RangeError(`Insufficient data in parsing ${ee(i)} at ${o} (${n} in the current buffer)`)}finally{this.entered=!1}}decodeArrayStream(e){return this.decodeMultiAsync(e,!0)}decodeStream(e){return this.decodeMultiAsync(e,!1)}async*decodeMultiAsync(e,t){if(this.entered){yield*this.clone().decodeMultiAsync(e,t);return}try{this.entered=!0;let s=t,i=-1;for await(const n of e){if(t&&i===0)throw this.createExtraByteError(this.totalPos);this.appendBuffer(n),s&&(i=this.readArraySize(),s=!1,this.complete());try{for(;yield this.doDecodeSync(),--i!==0;);}catch(o){if(!(o instanceof RangeError))throw o}this.totalPos+=this.pos}}finally{this.entered=!1}}doDecodeSync(){e:for(;;){const e=this.readHeadByte();let t;if(e>=224)t=e-256;else if(e<192)if(e<128)t=e;else if(e<144){const i=e-128;if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e<160){const i=e-144;if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else{const i=e-160;t=this.decodeString(i,0)}else if(e===192)t=null;else if(e===194)t=!1;else if(e===195)t=!0;else if(e===202)t=this.readF32();else if(e===203)t=this.readF64();else if(e===204)t=this.readU8();else if(e===205)t=this.readU16();else if(e===206)t=this.readU32();else if(e===207)this.useBigInt64?t=this.readU64AsBigInt():t=this.readU64();else if(e===208)t=this.readI8();else if(e===209)t=this.readI16();else if(e===210)t=this.readI32();else if(e===211)this.useBigInt64?t=this.readI64AsBigInt():t=this.readI64();else if(e===217){const i=this.lookU8();t=this.decodeString(i,1)}else if(e===218){const i=this.lookU16();t=this.decodeString(i,2)}else if(e===219){const i=this.lookU32();t=this.decodeString(i,4)}else if(e===220){const i=this.readU16();if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else if(e===221){const i=this.readU32();if(i!==0){this.pushArrayState(i),this.complete();continue e}else t=[]}else if(e===222){const i=this.readU16();if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e===223){const i=this.readU32();if(i!==0){this.pushMapState(i),this.complete();continue e}else t={}}else if(e===196){const i=this.lookU8();t=this.decodeBinary(i,1)}else if(e===197){const i=this.lookU16();t=this.decodeBinary(i,2)}else if(e===198){const i=this.lookU32();t=this.decodeBinary(i,4)}else if(e===212)t=this.decodeExtension(1,0);else if(e===213)t=this.decodeExtension(2,0);else if(e===214)t=this.decodeExtension(4,0);else if(e===215)t=this.decodeExtension(8,0);else if(e===216)t=this.decodeExtension(16,0);else if(e===199){const i=this.lookU8();t=this.decodeExtension(i,1)}else if(e===200){const i=this.lookU16();t=this.decodeExtension(i,2)}else if(e===201){const i=this.lookU32();t=this.decodeExtension(i,4)}else throw new B(`Unrecognized type byte: ${ee(e)}`);this.complete();const s=this.stack;for(;s.length>0;){const i=s.top();if(i.type===ne)if(i.array[i.position]=t,i.position++,i.position===i.size)t=i.array,s.release(i);else continue e;else if(i.type===X){if(t==="__proto__")throw new B("The key __proto__ is not allowed");i.key=this.mapKeyConverter(t),i.type=Fe;continue e}else if(i.map[i.key]=t,i.readCount++,i.readCount===i.size)t=i.map,s.release(i);else{i.key=null,i.type=X;continue e}}return t}}readHeadByte(){return this.headByte===K&&(this.headByte=this.readU8()),this.headByte}complete(){this.headByte=K}readArraySize(){const e=this.readHeadByte();switch(e){case 220:return this.readU16();case 221:return this.readU32();default:{if(e<160)return e-144;throw new B(`Unrecognized array type byte: ${ee(e)}`)}}}pushMapState(e){if(e>this.maxMapLength)throw new B(`Max length exceeded: map length (${e}) > maxMapLengthLength (${this.maxMapLength})`);this.stack.pushMapState(e)}pushArrayState(e){if(e>this.maxArrayLength)throw new B(`Max length exceeded: array length (${e}) > maxArrayLength (${this.maxArrayLength})`);this.stack.pushArrayState(e)}decodeString(e,t){return!this.rawStrings||this.stateIsMapKey()?this.decodeUtf8String(e,t):this.decodeBinary(e,t)}decodeUtf8String(e,t){var s;if(e>this.maxStrLength)throw new B(`Max length exceeded: UTF-8 byte length (${e}) > maxStrLength (${this.maxStrLength})`);if(this.bytes.byteLength<this.pos+t+e)throw Ue;const i=this.pos+t;let n;return this.stateIsMapKey()&&(s=this.keyDecoder)!=null&&s.canBeCached(e)?n=this.keyDecoder.decode(this.bytes,i,e):n=Yt(this.bytes,i,e),this.pos+=t+e,n}stateIsMapKey(){return this.stack.length>0?this.stack.top().type===X:!1}decodeBinary(e,t){if(e>this.maxBinLength)throw new B(`Max length exceeded: bin length (${e}) > maxBinLength (${this.maxBinLength})`);if(!this.hasRemaining(e+t))throw Ue;const s=this.pos+t,i=this.bytes.subarray(s,s+e);return this.pos+=t+e,i}decodeExtension(e,t){if(e>this.maxExtLength)throw new B(`Max length exceeded: ext length (${e}) > maxExtLength (${this.maxExtLength})`);const s=this.view.getInt8(this.pos+t),i=this.decodeBinary(e,t+1);return this.extensionCodec.decode(i,s,this.context)}lookU8(){return this.view.getUint8(this.pos)}lookU16(){return this.view.getUint16(this.pos)}lookU32(){return this.view.getUint32(this.pos)}readU8(){const e=this.view.getUint8(this.pos);return this.pos++,e}readI8(){const e=this.view.getInt8(this.pos);return this.pos++,e}readU16(){const e=this.view.getUint16(this.pos);return this.pos+=2,e}readI16(){const e=this.view.getInt16(this.pos);return this.pos+=2,e}readU32(){const e=this.view.getUint32(this.pos);return this.pos+=4,e}readI32(){const e=this.view.getInt32(this.pos);return this.pos+=4,e}readU64(){const e=Zt(this.view,this.pos);return this.pos+=8,e}readI64(){const e=De(this.view,this.pos);return this.pos+=8,e}readU64AsBigInt(){const e=this.view.getBigUint64(this.pos);return this.pos+=8,e}readI64AsBigInt(){const e=this.view.getBigInt64(this.pos);return this.pos+=8,e}readF32(){const e=this.view.getFloat32(this.pos);return this.pos+=4,e}readF64(){const e=this.view.getFloat64(this.pos);return this.pos+=8,e}}function xs(r,e){return new le(e).decode(r)}function Us(r){switch(r){case"Number":return"int";case"Boolean":return"bool";case"String":return"str";case"Array":return"list";case"Object":return"dict";case"ArrayBuffer":case"Blob":return"bytes";case"t":return"ndarray";default:return r}}function ks(r){return new Promise((e,t)=>{let s=new FileReader;s.onload=()=>{e(new Uint8Array(s.result)),s.close()},s.onerror=()=>{t(s.error),s.close()},s.readAsArrayBuffer(r)})}function Is(r){let e=r.src;if(e)return e.startsWith("data")?e.split(";")[0].split(":")[1]:e.endsWith(".png")?"image/png":e.endsWith(".jpg")||e.endsWith(".jpeg")?"image/jpeg":e.endsWith(".gif")?"image/gif":e.endsWith(".bmp")?"image/bmp":"image/png"}async function We(r,e=null){return{type:"bytes",data:await ks(r),dtype:r.type}}function Es(r){return new Promise((e,t)=>{let s=document.createElement("canvas"),i=s.getContext("2d"),n=Is(r);s.width=datum.width,s.height=datum.height,i.drawImage(datum,0,0),s.toBlob(o=>{We(o,n).then(e).catch(t)},n)})}class T{static async pack(e){if(e==null)return{type:"null"};if(e instanceof ArrayBuffer)return{type:"bytes",data:new Uint8Array(e)};if(e instanceof Blob)return await We(e);if(e instanceof A)return e.packed;if(A.isTypedArray(e))return new A(e).packed;if(typeof Image<"u"&&e instanceof Image)return await Es(e);if(typeof e=="function")return{type:"type",dtype:Us(e.name)};if(typeof e=="number")return{type:e%1===0?"int":"float",data:e};if(typeof e=="boolean")return{type:"bool",data:e};if(typeof e=="string")return{type:"str",data:new TextEncoder("utf-8").encode(e)};if(Array.isArray(e))return{type:"list",items:await Promise.all(e.map(T.pack))};if(typeof e=="object"){let t=Object.keys(e),s=[];for(let o in e)s.push(T.pack(e[o]));let i=await Promise.all(s),n={};for(let o=0;o<t.length;o++)n[t[o]]=i[o];return{type:"dict",props:n}}else throw new Error("Unsupported datum type: ${typeof datum} (${datum.constructor.name})")}static async unpack(e){return new Promise((t,s)=>{switch(e.type){case"null":return t(null);case"int":case"float":case"bool":return t(e.data);case"bytes":return t(e.data.buffer);case"str":let i=new TextDecoder("utf-8");return t(i.decode(e.data));case"list":return Promise.all(e.items.map(T.unpack)).then(t).catch(s);case"dict":let n=[],o=[];for(let l in e.props)n.push(l),o.push(T.unpack(e.props[l]));return Promise.all(o).then(l=>{let k={};for(let L=0;L<n.length;L++)k[n[L]]=l[L];t(k)}).catch(s);case"ndarray":case"tensor":return t(new A(e.data,e.shape,e.dtype));case"image":if(typeof Image>"u")return s(new Error("Image is not supported in this environment."));const a=new Blob([e.data],{type:`image/${e.dtype}`}),h=URL.createObjectURL(a),f=new Image;return f.addEventListener("load",()=>{t(f)}),f.src=h,f;case"audio":const w=new Blob([e.data],{type:`audio/${e.dtype}`}),u=URL.createObjectURL(w),g=new Audio;return g.addEventListener("loadeddata",()=>{t(g)}),g.src=u,g;case"exception":let y=new TextDecoder("utf-8").decode(e.data);return t(new Error(`${e.dtype}: ${y}`));default:console.error("Unhandled response type",e),s(new Error(`Unsupported packed type: ${e.type}`))}})}static async encode(e){let t=await T.pack(e);return fs(t)}static async decode(e){let t=xs(e);return await T.unpack(t)}}class Oe{constructor(){this.holder=Promise.resolve()}acquire(){let e,t=new Promise(i=>{e=()=>i()}),s=this.holder.then(()=>e);return this.holder=t,s}}function*bs(r,e){for(let t=0;t<r.length;t+=e)yield r.slice(t,t+e)}const As=1024*1024;class Ss{constructor(e,t=!1){this.socket=null,this.address=e,this.lock=new Oe,this.debug=t,this.messageLength=null,this.messageBuffer=[],this.messageListeners=[],this.errorListeners=[]}get isWebsocket(){return this.address.startsWith("ws://")||this.address.startsWith("wss://")}get isSecure(){return this.address.startsWith("wss://")||this.address.startsWith("https://")||!this.hasProtocol&&window!==void 0&&window.location.protocol==="https:"}get hasProtocol(){return this.addressHasProtocol(this.address)}get host(){return this.hasProtocol?new URL(this.address).host:window!==void 0&&window.location!==void 0?window.location.host:null}get address(){return this.url}set address(e){this.url=e,!(this.socket&&this.socket.url===e)&&this.close()}addressHasProtocol(e){return/^[a-z]+:\/\//.test(e)}getWebsocket(){return new Promise((e,t)=>{this.lock.acquire().then(s=>{try{if(this.socket!==null&&this.socket!==void 0)if(this.socket.readyState===WebSocket.OPEN){e(this.socket);return}else this.socket.readyState!==WebSocket.CONNECTING&&this.close();if(this.socket===null||this.socket===void 0)this.socket=new WebSocket(this.address),this.socket.binaryType="arraybuffer",this.socket.addEventListener("open",()=>{e(this.socket)}),this.socket.addEventListener("message",async i=>{await this.pushMessageChunk(i.data)}),this.socket.addEventListener("error",i=>{this.dispatchError(i)});else throw new Error(`WebSocket connection is in state ${this.socket.readyState}.`)}catch(i){if(console.error("Error getting WebSocket connection:",i),this.socket!==null&&this.socket!==void 0){try{this.socket.close()}catch{}delete this.socket}this.dispatchError(i),t(i)}finally{s()}})})}close(){this.socket&&this.socket.readyState===WebSocket.OPEN&&this.lock.acquire().then(e=>{this.socket.close(),delete this.socket,e()})}async pushMessageChunk(e){this.messageLength===null&&e.byteLength>=4&&(this.messageLength=new DataView(e).getUint32(0),e=e.slice(4)),this.messageBuffer.push(new Uint8Array(e));let t=this.messageBuffer.reduce((s,i)=>s+i.byteLength,0);this.messageLength!==null&&t>=this.messageLength&&(this.messageBuffer.length===1?this.dispatchMessage(await T.decode(this.messageBuffer[0])):this.dispatchMessage(await T.decode(xe(this.messageBuffer))),this.messageLength=null,this.messageBuffer=[])}onMessage(e){this.messageListeners.push(e)}onError(e){this.errorListeners.push(e)}offMessage(e){this.messageListeners=this.messageListeners.filter(t=>t!==e)}offError(e){this.errorListeners=this.errorListeners.filter(t=>t!==e)}dispatchMessage(e){this.debug&&console.log("Received message:",e),this.messageListeners.forEach(t=>t(e))}dispatchError(e){this.debug&&console.error("Received error:",e),this.errorListeners.forEach(t=>t(e))}send(e,t=!0){return this.debug&&console.log("Sending message:",e,"to",this.address),new Promise(async(s,i)=>{try{if(this.isWebsocket){let[n,o]=await Promise.all([this.getWebsocket(),T.encode(e)]);if(t){let f=u=>{s(u),this.offMessage(f)},w=u=>{i(u),this.offError(w)};this.onMessage(f),this.onError(w)}let a=new Uint8Array(new ArrayBuffer(4)),h=!1;new DataView(a.buffer).setUint32(0,o.length);for(let f of bs(o,As))h?await n.send(f):(await n.send(xe([a,f])),h=!0);t||s()}else{let n=await T.encode(e),o=await fetch(this.address,{method:"POST",body:n,headers:{"Content-Type":"application/octet-stream"}});if(o.ok){let a=await o.arrayBuffer(),h=await T.decode(new Uint8Array(a));this.dispatchMessage(h),s(h)}else{let a=new Error(`Error sending message: ${o.statusText}`);this.dispatchError(a),i(a)}}}catch(n){i(n)}})}}class ke extends Ss{send(e,t=!0){if(typeof e=="string")return super.send(e,t);if(!e instanceof Object)throw new Error("Message must be an object.");let s;if(e.request!==void 0&&e.request!==null&&e.request.id!==void 0)s=e.request.id;else if(e.id!==void 0)s=e.id;else throw new Error("Message must have an ID.");return t?new Promise((i,n)=>{let o=h=>{h instanceof Error?n(h):h.id===s&&(i(h),this.offMessage(o))},a=h=>{n(h),this.offError(a),this.offMessage(o)};this.onMessage(o),this.onError(a),super.send(e,!1)}):super.send(e,!1)}}class Bs{constructor(e){this.driver=e,this.scopes={}}getScope(e,t){return this.scopes.hasOwnProperty(e)||(this.scopes[e]=new vs(e,this.driver,t)),this.scopes[e]}getAll(){return Object.getOwnPropertyNames(this.scopes).reduce((e,t)=>(e[t]=storage.getScope(t).getAll(),e),{})}clear(){for(let e in this.scopes)this.getScope(e).clear()}}class vs{constructor(e,t,s){this.scope=e,this.driver=t,this.ttl=s,this.ttl===void 0&&(this.ttl=60*60*1e3)}getAll(){return this.keys().reduce((e,t)=>(e[t]=storage.getItem(t),e),{})}setItem(e,t){let s=`${this.scope}-${e}`,i=`${this.scope}-${e}-expiration`;this.driver.setItem(s,JSON.stringify(t)),this.driver.setItem(i,new Date().getTime()+this.ttl)}getItem(e){let t=`${this.scope}-${e}`,s=`${this.scope}-${e}-expiration`,i=this.driver.getItem(t),n=this.driver.getItem(s);if(!(i===void 0||i==="undefined"))return i===null||i==="null"?null:(i=JSON.parse(i),!q(n)&&n<=new Date().getTime()?(this.removeItem(t),null):i)}keys(){let e=`${this.scope}-`,t;return this.driver.keys!==void 0?t=this.driver.keys():t=Object.getOwnPropertyNames(this.driver),t.filter(s=>s.startsWith(e)).map(s=>s.substring(e.length)).filter(s=>s!="expiration")}removeItem(e){let t=`${this.scope}-${e}`;return this.driver.removeItem(t)}removePrefix(e){for(let t of this.keys())t.startsWith(e)&&this.removeItem(t)}clear(){for(let e of this.keys())this.removeItem(e);return this.setItem("expiration",{}),this.driver.clear()}key(e){return this.keys()[e]}}class Ie{constructor(){this.expiration=new Date,this.expiration.setTime(this.expiration.getTime()+30*24*60*60*1e3)}keys(){let e=decodeURIComponent(document.cookie).split(";"),t,s=[];for(let i of e){for(t=i.split("=")[0];t.charAt(0)==" ";)t=t.substring(1);s.push(t)}return s}getItem(e){let t=decodeURIComponent(document.cookie).split(";");for(let s of t){for(;s.charAt(0)==" ";)s=s.substring(1);if(s.startsWith(`${e}=`))return JSON.parse(s.substring(e.length+1))}return null}setItem(e,t,s){s===void 0&&(s=this.expiration),document.cookie=[`${e}=${JSON.stringify(t)}`,`expires=${s.toUTCString()}`,"path=/",""].join(";")}removeItem(e){let t=new Date;t.setTime(0),this.setItem(e,"",t)}clear(){for(let e of this.keys())this.removeItem(e)}key(e){return this.keys()[e]}}class Ts{constructor(){this.storage={}}keys(){return Object.getOwnPropertyNames(this.storage)}setItem(e,t){this.storage[e]=t}getItem(e){return this.storage.hasOwnProperty(e)?this.storage[e]:null}removeItem(e){delete this.storage[e]}removePrefix(e){for(let t of this.keys())t.startsWith(e)&&this.removeItem(t)}clear(){for(let e of this.keys)delete this.storage[e]}key(e){return this.keys()[e]}}let Ls=function(){try{return typeof localStorage<"u"?localStorage:typeof window<"u"?new Ie:new Ts}catch(r){return console.error("Couldn't get local storage, defaulting to cookies.",r),new Ie}},Ms=new Bs(Ls());const Ee=Ms.getScope("taproot");function oe(r=null){if(r==null)return{type:"NoneType"};let e={parameter_type:r.constructor,parameter_size:1};if(typeof Blob<"u"&&r instanceof Blob)e.parameter_type="bytes",e.parameter_size=r.size;else if(r instanceof A)e.parameter_size=r.shape;else if(A.isTypedArray(r))r=new A(r),e.parameter_type=A,e.parameter_size=r.shape;else if(typeof Image<"u"&&r instanceof Image)e.parameter_size=[r.width,r.height];else if(Array.isArray(r))e.parameter_size=[r.length],e.parameter_sub_metadata=oe(r[0]);else if(e.parameter_type===Object){e.parameter_size=Object.keys(r).length,e.parameter_sub_metadata={};for(let t in r)e.parameter_sub_metadata[t]=oe(r[t])}else r.length!==void 0&&(e.parameter_size=r.length);return e}function Ps(r){let e={};for(let t in r)e[t]=oe(r[t]);return e}class $s extends ke{get completeAddress(){if(this.hasProtocol)return this.address;if(typeof window<"u"&&window.location!==void 0){let e=window.location.href;if(this.isWebsocket&&(e=e.replace("http://","ws://").replace("https://","wss://")),!e.endsWith("/"))if(window.location.href===window.location.origin)e+="/";else{let t=e.lastIndexOf("/");e=e.substring(0,t+1)}return this.address.startsWith("/")?`${e}${this.address.substring(1)}`:`${e}${this.address}`}return this.address}get clientId(){let e=Ee.getItem("clientId");if(e)return e;let t=me();return Ee.setItem("clientId",t),t}getClient(e){return(this.executors===null||this.executors===void 0)&&(this.executors={}),this.isWebsocket&&!this.addressHasProtocol(e)&&(e.startsWith("/")&&(e=e.substring(1)),this.host!==null?this.isSecure?e=`wss://${this.host}/${e}`:e=`ws://${this.host}/${e}`:this.isSecure?e=`wss://${e}`:e=`ws://${e}`),(this.executors[e]===null||this.executors[e]===void 0)&&(this.debug&&console.log(`Creating new client for ${e}`),this.executors[e]=new ke(e,this.debug)),this.executors[e]}clearClientForTask(e,t=null){(this.tasks===null||this.tasks===void 0)&&(this.tasks={}),(this.tasks[e]===null||this.tasks[e]===void 0)&&(this.tasks[e]={}),t==null&&(t="default"),this.tasks[e][t]!==null&&this.tasks[e][t]!==void 0&&this.tasks[e][t].close(),this.tasks[e][t]=null}setClientForTask(e,t,s=null){(this.tasks===null||this.tasks===void 0)&&(this.tasks={}),(this.tasks[t]===null||this.tasks[t]===void 0)&&(this.tasks[t]={}),s==null&&(s="default"),this.tasks[t][s]=e}getClientForTask(e,t=null){return(this.tasks===null||this.tasks===void 0)&&(this.tasks={}),(this.tasks[e]===null||this.tasks[e]===void 0)&&(this.tasks[e]={}),t==null&&(t="default"),this.tasks[e][t]!==null&&this.tasks[e][t]!==void 0?this.tasks[e][t]:null}getLockForTask(e,t=null){return(this.locks===null||this.locks===void 0)&&(this.locks={}),(this.locks[e]===null||this.locks[e]===void 0)&&(this.locks[e]={}),t==null&&(t="default"),(this.locks[e][t]===null||this.locks[e][t]===void 0)&&(this.locks[e][t]=new Oe),this.locks[e][t]}sendInvocation(e,t){t=t||{};let s=e.task,i=e.model||null,n=e.continuation,o=0,a=t.fetchIntermediates,h=t.pollingInterval||1e3,f=t.retryDelay||20,w=t.onIntermediateResult||((g,y)=>console.log("Ignored intermediate result",y,g)),u=t.onInterimResult||((g,y)=>console.log("Ignored interim result",y,g));if(q(s))throw new Error("Task is required.");return new Promise((g,y)=>{e.id=me(),e.client_id=this.clientId,e.overseer=this.completeAddress,e.return_metadata=!0,e.wait_for_result=!a;let l=this.getClientForTask(s,i),k=(c,I=3)=>new Promise((p,m)=>{let x=c.id,F=c.address,U=this.getClient(F),W=()=>U.send({id:x,client_id:this.clientId,return_metadata:!0,wait_for_result:!a}),M=d=>{U.offError(M),U.offMessage(P),retry?k(c,!1).then(p).catch(m):(console.error("Error with continuation",x,"from",F,d),m(d))},P=d=>{if(d instanceof Error)U.offMessage(P),U.offError(M),I>0?setTimeout(()=>{k(c,I-1).then(p).catch(m)},f):(console.error("Error with continuation",x,"from",F,d),m(d));else if(d.id==x)if(["error","complete"].includes(d.status))if(U.offMessage(P),U.offError(M),d.status==="error")m(d.result);else if(d.continuation){u(d.result,o),o++;let $=d.continuation,O=!1;Array.isArray($)||($=[$],O=!0);let R=[];for(let C of $)R.push(k(C));Promise.all(R).then(C=>{p(O?C[0]:C)}).catch(m)}else p(d.result);else q(d.intermediate)||w(d.intermediate,o),setTimeout(W,h)};U.onMessage(P),U.onError(M),W()}),L=()=>l.send({id:e.id,client_id:this.clientId,return_metadata:!0,wait_for_result:!a}),E=c=>{if(c.id===e.id)if(["error","complete"].includes(c.status))if(l.offMessage(E),l.offError(D),n)if(u(c.result,o),o++,!c.continuation||!c.continuation.id)y("Continuation request but not found in message");else{let I=c.continuation,p=!1;Array.isArray(I)||(I=[I],p=!0);let m=[];for(let x of I)m.push(k(x));Promise.all(m).then(x=>{g(p?x[0]:x)}).catch(y)}else g(c.result);else q(c.intermediate)||w(c.intermediate,o),setTimeout(L,h)},D=c=>{l.offMessage(E),l.offError(D),y(c)},z=e.parameters;if(l===null)e.parameters=Ps(z),this.send(e).then(c=>{if(c.address){if(c.address.startsWith("tcp://")||c.address.startsWith("tcps://")||c.address.startsWith("unix://")){y(`Executor is not configured for websocket or HTTP communication, received: ${c.address}`);return}}else{y("No address found for executor.");return}e.parameters=z,l=this.getClient(c.address),l.onMessage(E),l.onError(D),l.send(e,!1),this.setClientForTask(l,s,i)}).catch(y);else{this.debug&&console.log("Reusing client for task",s);let c=I=>{l.offMessage(E),l.offError(c),this.clearClientForTask(s,i),this.sendInvocation(e,t).then(p=>{g(p)}).catch(p=>{y(p)})};e.parameters=z,l.onMessage(E),l.onError(c),l.send(e,!1)}})}invoke(e,t){let s=e.task,i=e.model||null;if(q(s))throw new Error("Task is required.");return new Promise((n,o)=>{this.getLockForTask(s,i).acquire().then(a=>this.sendInvocation(e,t).then(h=>{a(),n(h)}).catch(h=>{a(),o(h)}))})}close(){for(let e in this.tasks)for(let t in this.tasks[e])this.clearClientForTask(e,t);super.close()}}typeof window<"u"&&(window.Taproot=$s);
