/*! For license information please see taproot.min.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.taproot=e():t.taproot=e()}(this,(()=>(()=>{"use strict";var t={d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,o,i,s,a=[],c=!0,u=!1;try{if(i=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=i.call(r)).done)&&(a.push(n.value),a.length!==e);c=!0);}catch(t){u=!0,o=t}finally{try{if(!c&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(u)throw o}}return a}}(t,e)||function(t,e){if(t){if("string"==typeof t)return n(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function n(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function o(t){return o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},o(t)}function i(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,s(n.key),n)}}function s(t){var e=function(t,e){if("object"!=o(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=o(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==o(e)?e:e+""}t.r(e),t.d(e,{Taproot:()=>Qt});var a=function(){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),e instanceof t)this.data=e.data,this.shape=e.shape,this.dtype=e.dtype;else if(t.isTypedArray(e)){var i=t.getDataTypeFromTypedArray(e);null!==n&&i!==n?(this.data=new(t.getArrayConstructorFromDataType(n))(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)),this.dtype=n):(this.data=e,this.dtype=i),null===r&&(r=[e.length]),this.shape=r}else if(null!==n)this.data=new(t.getArrayConstructorFromDataType(n))(e),null===r&&(r=[e.length]),this.shape=r,this.dtype=n;else{if(!Array.isArray(e))throw new Error("Invalid data type ".concat(o(e)," (").concat(e.constructor.name,")"));this.data=new Int32Array(e),this.shape=[e.length],this.dtype="int32"}}return e=t,n=[{key:"get",value:function(){var t=Array.from(arguments);if(t.length!==this.shape.length)throw new Error("Incorrect number of indexes");for(var e=0,r=0;r<t.length;r++)e+=t[r]*this.strides[r];return this.data[e]}},{key:"set",value:function(){var t=Array.from(arguments),e=t.pop();if(t.length!==this.shape.length)throw new Error("Incorrect number of indexes");for(var r=0,n=0;n<t.length;n++)r+=t[n]*this.strides[n];this.data[r]=e}},{key:"packed",get:function(){return{type:"ndarray",shape:this.shape,dtype:this.dtype,data:this.data}}},{key:"imageData",get:function(){if(3!==this.shape.length)throw new Error("Can only get ImageData from 3D array (height, width, channels)");var t=r(this.shape,3),e=t[0],n=t[1];if(3===t[2]){for(var o=new Uint8ClampedArray(n*e*4),i=0;i<n*e;i++)o[4*i]=this.data[3*i],o[4*i+1]=this.data[3*i+1],o[4*i+2]=this.data[3*i+2],o[4*i+3]=255;return new ImageData(o,n,e)}return new ImageData(new Uint8ClampedArray(this.data.buffer.slice(this.data.byteOffset,this.data.byteOffset+this.data.byteLength)),n,e)}},{key:"toString",value:function(){return"NDArray(".concat(this.data,", ").concat(this.shape,", ").concat(this.dtype,")")}}],s=[{key:"getDataTypeFromTypedArray",value:function(e){if(t.isTypedArray(e))return e.constructor.name.replace("Array","").toLowerCase();throw new Error("Not a typed array: ".concat(e.constructor.name))}},{key:"getArrayConstructorFromDataType",value:function(t){switch(t){case"float32":return Float32Array;case"float64":return Float64Array;case"int8":return Int8Array;case"int16":return Int16Array;case"int32":return Int32Array;case"uint8":return Uint8Array;case"uint16":return Uint16Array;case"uint32":return Uint32Array;default:throw new Error("Unknown data type: ".concat(t))}}},{key:"isTypedArray",value:function(t){return t instanceof Float32Array||t instanceof Float64Array||t instanceof Int8Array||t instanceof Int16Array||t instanceof Int32Array||t instanceof Uint8Array||t instanceof Uint16Array||t instanceof Uint32Array}}],n&&i(e.prototype,n),s&&i(e,s),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,s}();var c=new TextEncoder;function u(t,e,r){t.length>50?function(t,e,r){c.encodeInto(t,e.subarray(r))}(t,e,r):function(t,e,r){for(var n=t.length,o=r,i=0;i<n;){var s=t.charCodeAt(i++);if(4294967168&s){if(4294965248&s){if(s>=55296&&s<=56319&&i<n){var a=t.charCodeAt(i);56320==(64512&a)&&(++i,s=((1023&s)<<10)+(1023&a)+65536)}4294901760&s?(e[o++]=s>>18&7|240,e[o++]=s>>12&63|128,e[o++]=s>>6&63|128):(e[o++]=s>>12&15|224,e[o++]=s>>6&63|128)}else e[o++]=s>>6&31|192;e[o++]=63&s|128}else e[o++]=s}}(t,e,r)}function f(t,e,r){for(var n=e,o=n+r,i=[],s="";n<o;){var a=t[n++];if(128&a)if(192==(224&a)){var c=63&t[n++];i.push((31&a)<<6|c)}else if(224==(240&a)){c=63&t[n++];var u=63&t[n++];i.push((31&a)<<12|c<<6|u)}else if(240==(248&a)){var f=(7&a)<<18|(c=63&t[n++])<<12|(u=63&t[n++])<<6|63&t[n++];f>65535&&(f-=65536,i.push(f>>>10&1023|55296),f=56320|1023&f),i.push(f)}else i.push(a);else i.push(a);i.length>=4096&&(s+=String.fromCharCode.apply(String,i),i.length=0)}return i.length>0&&(s+=String.fromCharCode.apply(String,i)),s}var l=new TextDecoder;function h(t,e,r){return r>200?function(t,e,r){var n=t.subarray(e,e+r);return l.decode(n)}(t,e,r):f(t,e,r)}var p,y=function(t,e){this.type=t,this.data=e},d=(p=function(t,e){return p=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},p(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}p(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}),v=function(t){function e(r){var n=t.call(this,r)||this,o=Object.create(e.prototype);return Object.setPrototypeOf(n,o),Object.defineProperty(n,"name",{configurable:!0,enumerable:!1,value:e.name}),n}return d(e,t),e}(Error),g=4294967295;function m(t,e,r){var n=Math.floor(r/4294967296),o=r;t.setUint32(e,n),t.setUint32(e+4,o)}function w(t,e){return 4294967296*t.getInt32(e)+t.getUint32(e+4)}var b={type:-1,encode:function(t){var e,r,n,o;return t instanceof Date?function(t){var e,r=t.sec,n=t.nsec;if(r>=0&&n>=0&&r<=17179869183){if(0===n&&r<=4294967295){var o=new Uint8Array(4);return(e=new DataView(o.buffer)).setUint32(0,r),o}var i=r/4294967296,s=4294967295&r;return o=new Uint8Array(8),(e=new DataView(o.buffer)).setUint32(0,n<<2|3&i),e.setUint32(4,s),o}return o=new Uint8Array(12),(e=new DataView(o.buffer)).setUint32(0,n),m(e,4,r),o}((e=t.getTime(),r=Math.floor(e/1e3),n=1e6*(e-1e3*r),o=Math.floor(n/1e9),{sec:r+o,nsec:n-1e9*o})):null},decode:function(t){var e=function(t){var e=new DataView(t.buffer,t.byteOffset,t.byteLength);switch(t.byteLength){case 4:return{sec:e.getUint32(0),nsec:0};case 8:var r=e.getUint32(0);return{sec:4294967296*(3&r)+e.getUint32(4),nsec:r>>>2};case 12:return{sec:w(e,4),nsec:e.getUint32(0)};default:throw new v("Unrecognized data size for timestamp (expected 4, 8, or 12): ".concat(t.length))}}(t);return new Date(1e3*e.sec+e.nsec/1e6)}},k=function(){function t(){this.builtInEncoders=[],this.builtInDecoders=[],this.encoders=[],this.decoders=[],this.register(b)}return t.prototype.register=function(t){var e=t.type,r=t.encode,n=t.decode;if(e>=0)this.encoders[e]=r,this.decoders[e]=n;else{var o=1+e;this.builtInEncoders[o]=r,this.builtInDecoders[o]=n}},t.prototype.tryToEncode=function(t,e){for(var r=0;r<this.builtInEncoders.length;r++){if(null!=(n=this.builtInEncoders[r]))if(null!=(o=n(t,e)))return new y(-1-r,o)}for(r=0;r<this.encoders.length;r++){var n,o;if(null!=(n=this.encoders[r]))if(null!=(o=n(t,e)))return new y(r,o)}return t instanceof y?t:null},t.prototype.decode=function(t,e,r){var n=e<0?this.builtInDecoders[-1-e]:this.decoders[e];return n?n(t,e,r):new y(e,t)},t.defaultCodec=new t,t}();function x(t){return t instanceof Uint8Array?t:ArrayBuffer.isView(t)?new Uint8Array(t.buffer,t.byteOffset,t.byteLength):t instanceof ArrayBuffer?new Uint8Array(t):Uint8Array.from(t)}var S=function(){function t(t){var e,r,n,o,i,s,a,c;this.extensionCodec=null!==(e=null==t?void 0:t.extensionCodec)&&void 0!==e?e:k.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!==(r=null==t?void 0:t.useBigInt64)&&void 0!==r&&r,this.maxDepth=null!==(n=null==t?void 0:t.maxDepth)&&void 0!==n?n:100,this.initialBufferSize=null!==(o=null==t?void 0:t.initialBufferSize)&&void 0!==o?o:2048,this.sortKeys=null!==(i=null==t?void 0:t.sortKeys)&&void 0!==i&&i,this.forceFloat32=null!==(s=null==t?void 0:t.forceFloat32)&&void 0!==s&&s,this.ignoreUndefined=null!==(a=null==t?void 0:t.ignoreUndefined)&&void 0!==a&&a,this.forceIntegerToFloat=null!==(c=null==t?void 0:t.forceIntegerToFloat)&&void 0!==c&&c,this.pos=0,this.view=new DataView(new ArrayBuffer(this.initialBufferSize)),this.bytes=new Uint8Array(this.view.buffer)}return t.prototype.reinitializeState=function(){this.pos=0},t.prototype.encodeSharedRef=function(t){return this.reinitializeState(),this.doEncode(t,1),this.bytes.subarray(0,this.pos)},t.prototype.encode=function(t){return this.reinitializeState(),this.doEncode(t,1),this.bytes.slice(0,this.pos)},t.prototype.doEncode=function(t,e){if(e>this.maxDepth)throw new Error("Too deep objects in depth ".concat(e));null==t?this.encodeNil():"boolean"==typeof t?this.encodeBoolean(t):"number"==typeof t?this.forceIntegerToFloat?this.encodeNumberAsFloat(t):this.encodeNumber(t):"string"==typeof t?this.encodeString(t):this.useBigInt64&&"bigint"==typeof t?this.encodeBigInt64(t):this.encodeObject(t,e)},t.prototype.ensureBufferSizeToWrite=function(t){var e=this.pos+t;this.view.byteLength<e&&this.resizeBuffer(2*e)},t.prototype.resizeBuffer=function(t){var e=new ArrayBuffer(t),r=new Uint8Array(e),n=new DataView(e);r.set(this.bytes),this.view=n,this.bytes=r},t.prototype.encodeNil=function(){this.writeU8(192)},t.prototype.encodeBoolean=function(t){!1===t?this.writeU8(194):this.writeU8(195)},t.prototype.encodeNumber=function(t){!this.forceIntegerToFloat&&Number.isSafeInteger(t)?t>=0?t<128?this.writeU8(t):t<256?(this.writeU8(204),this.writeU8(t)):t<65536?(this.writeU8(205),this.writeU16(t)):t<4294967296?(this.writeU8(206),this.writeU32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(207),this.writeU64(t)):t>=-32?this.writeU8(224|t+32):t>=-128?(this.writeU8(208),this.writeI8(t)):t>=-32768?(this.writeU8(209),this.writeI16(t)):t>=-2147483648?(this.writeU8(210),this.writeI32(t)):this.useBigInt64?this.encodeNumberAsFloat(t):(this.writeU8(211),this.writeI64(t)):this.encodeNumberAsFloat(t)},t.prototype.encodeNumberAsFloat=function(t){this.forceFloat32?(this.writeU8(202),this.writeF32(t)):(this.writeU8(203),this.writeF64(t))},t.prototype.encodeBigInt64=function(t){t>=BigInt(0)?(this.writeU8(207),this.writeBigUint64(t)):(this.writeU8(211),this.writeBigInt64(t))},t.prototype.writeStringHeader=function(t){if(t<32)this.writeU8(160+t);else if(t<256)this.writeU8(217),this.writeU8(t);else if(t<65536)this.writeU8(218),this.writeU16(t);else{if(!(t<4294967296))throw new Error("Too long string: ".concat(t," bytes in UTF-8"));this.writeU8(219),this.writeU32(t)}},t.prototype.encodeString=function(t){var e=function(t){for(var e=t.length,r=0,n=0;n<e;){var o=t.charCodeAt(n++);if(4294967168&o)if(4294965248&o){if(o>=55296&&o<=56319&&n<e){var i=t.charCodeAt(n);56320==(64512&i)&&(++n,o=((1023&o)<<10)+(1023&i)+65536)}r+=4294901760&o?4:3}else r+=2;else r++}return r}(t);this.ensureBufferSizeToWrite(5+e),this.writeStringHeader(e),u(t,this.bytes,this.pos),this.pos+=e},t.prototype.encodeObject=function(t,e){var r=this.extensionCodec.tryToEncode(t,this.context);if(null!=r)this.encodeExtension(r);else if(Array.isArray(t))this.encodeArray(t,e);else if(ArrayBuffer.isView(t))this.encodeBinary(t);else{if("object"!=typeof t)throw new Error("Unrecognized object: ".concat(Object.prototype.toString.apply(t)));this.encodeMap(t,e)}},t.prototype.encodeBinary=function(t){var e=t.byteLength;if(e<256)this.writeU8(196),this.writeU8(e);else if(e<65536)this.writeU8(197),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too large binary: ".concat(e));this.writeU8(198),this.writeU32(e)}var r=x(t);this.writeU8a(r)},t.prototype.encodeArray=function(t,e){var r=t.length;if(r<16)this.writeU8(144+r);else if(r<65536)this.writeU8(220),this.writeU16(r);else{if(!(r<4294967296))throw new Error("Too large array: ".concat(r));this.writeU8(221),this.writeU32(r)}for(var n=0,o=t;n<o.length;n++){var i=o[n];this.doEncode(i,e+1)}},t.prototype.countWithoutUndefined=function(t,e){for(var r=0,n=0,o=e;n<o.length;n++){void 0!==t[o[n]]&&r++}return r},t.prototype.encodeMap=function(t,e){var r=Object.keys(t);this.sortKeys&&r.sort();var n=this.ignoreUndefined?this.countWithoutUndefined(t,r):r.length;if(n<16)this.writeU8(128+n);else if(n<65536)this.writeU8(222),this.writeU16(n);else{if(!(n<4294967296))throw new Error("Too large map object: ".concat(n));this.writeU8(223),this.writeU32(n)}for(var o=0,i=r;o<i.length;o++){var s=i[o],a=t[s];this.ignoreUndefined&&void 0===a||(this.encodeString(s),this.doEncode(a,e+1))}},t.prototype.encodeExtension=function(t){var e=t.data.length;if(1===e)this.writeU8(212);else if(2===e)this.writeU8(213);else if(4===e)this.writeU8(214);else if(8===e)this.writeU8(215);else if(16===e)this.writeU8(216);else if(e<256)this.writeU8(199),this.writeU8(e);else if(e<65536)this.writeU8(200),this.writeU16(e);else{if(!(e<4294967296))throw new Error("Too large extension object: ".concat(e));this.writeU8(201),this.writeU32(e)}this.writeI8(t.type),this.writeU8a(t.data)},t.prototype.writeU8=function(t){this.ensureBufferSizeToWrite(1),this.view.setUint8(this.pos,t),this.pos++},t.prototype.writeU8a=function(t){var e=t.length;this.ensureBufferSizeToWrite(e),this.bytes.set(t,this.pos),this.pos+=e},t.prototype.writeI8=function(t){this.ensureBufferSizeToWrite(1),this.view.setInt8(this.pos,t),this.pos++},t.prototype.writeU16=function(t){this.ensureBufferSizeToWrite(2),this.view.setUint16(this.pos,t),this.pos+=2},t.prototype.writeI16=function(t){this.ensureBufferSizeToWrite(2),this.view.setInt16(this.pos,t),this.pos+=2},t.prototype.writeU32=function(t){this.ensureBufferSizeToWrite(4),this.view.setUint32(this.pos,t),this.pos+=4},t.prototype.writeI32=function(t){this.ensureBufferSizeToWrite(4),this.view.setInt32(this.pos,t),this.pos+=4},t.prototype.writeF32=function(t){this.ensureBufferSizeToWrite(4),this.view.setFloat32(this.pos,t),this.pos+=4},t.prototype.writeF64=function(t){this.ensureBufferSizeToWrite(8),this.view.setFloat64(this.pos,t),this.pos+=8},t.prototype.writeU64=function(t){this.ensureBufferSizeToWrite(8),function(t,e,r){var n=r/4294967296,o=r;t.setUint32(e,n),t.setUint32(e+4,o)}(this.view,this.pos,t),this.pos+=8},t.prototype.writeI64=function(t){this.ensureBufferSizeToWrite(8),m(this.view,this.pos,t),this.pos+=8},t.prototype.writeBigUint64=function(t){this.ensureBufferSizeToWrite(8),this.view.setBigUint64(this.pos,t),this.pos+=8},t.prototype.writeBigInt64=function(t){this.ensureBufferSizeToWrite(8),this.view.setBigInt64(this.pos,t),this.pos+=8},t}();function E(t){return"".concat(t<0?"-":"","0x").concat(Math.abs(t).toString(16).padStart(2,"0"))}var U=function(){function t(t,e){void 0===t&&(t=16),void 0===e&&(e=16),this.maxKeyLength=t,this.maxLengthPerKey=e,this.hit=0,this.miss=0,this.caches=[];for(var r=0;r<this.maxKeyLength;r++)this.caches.push([])}return t.prototype.canBeCached=function(t){return t>0&&t<=this.maxKeyLength},t.prototype.find=function(t,e,r){t:for(var n=0,o=this.caches[r-1];n<o.length;n++){for(var i=o[n],s=i.bytes,a=0;a<r;a++)if(s[a]!==t[e+a])continue t;return i.str}return null},t.prototype.store=function(t,e){var r=this.caches[t.length-1],n={bytes:t,str:e};r.length>=this.maxLengthPerKey?r[Math.random()*r.length|0]=n:r.push(n)},t.prototype.decode=function(t,e,r){var n=this.find(t,e,r);if(null!=n)return this.hit++,n;this.miss++;var o=f(t,e,r),i=Uint8Array.prototype.slice.call(t,e,e+r);return this.store(i,o),o},t}(),I=function(t,e,r,n){return new(r||(r=Promise))((function(o,i){function s(t){try{c(n.next(t))}catch(t){i(t)}}function a(t){try{c(n.throw(t))}catch(t){i(t)}}function c(t){var e;t.done?o(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(s,a)}c((n=n.apply(t,e||[])).next())}))},A=function(t,e){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(a){return function(c){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i&&(i=0,a[0]&&(s=0)),s;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return s.label++,{value:a[1],done:!1};case 5:s.label++,n=a[1],a=[0];continue;case 7:a=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){s=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){s.label=a[1];break}if(6===a[0]&&s.label<o[1]){s.label=o[1],o=a;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(a);break}o[2]&&s.ops.pop(),s.trys.pop();continue}a=e.call(t,s)}catch(t){a=[6,t],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,c])}}},O=function(t){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e,r=t[Symbol.asyncIterator];return r?r.call(t):(t="function"==typeof __values?__values(t):t[Symbol.iterator](),e={},n("next"),n("throw"),n("return"),e[Symbol.asyncIterator]=function(){return this},e);function n(r){e[r]=t[r]&&function(e){return new Promise((function(n,o){(function(t,e,r,n){Promise.resolve(n).then((function(e){t({value:e,done:r})}),e)})(n,o,(e=t[r](e)).done,e.value)}))}}},L=function(t){return this instanceof L?(this.v=t,this):new L(t)},j=function(t,e,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,o=r.apply(t,e||[]),i=[];return n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n;function s(t){o[t]&&(n[t]=function(e){return new Promise((function(r,n){i.push([t,e,r,n])>1||a(t,e)}))})}function a(t,e){try{(r=o[t](e)).value instanceof L?Promise.resolve(r.value.v).then(c,u):f(i[0][2],r)}catch(t){f(i[0][3],t)}var r}function c(t){a("next",t)}function u(t){a("throw",t)}function f(t,e){t(e),i.shift(),i.length&&a(i[0][0],i[0][1])}},T="array",B="map_key",P=new DataView(new ArrayBuffer(0)),_=new Uint8Array(P.buffer);try{P.getInt8(0)}catch(t){if(!(t instanceof RangeError))throw new Error("This module is not supported in the current JavaScript engine because DataView does not throw RangeError on out-of-bounds access")}var C=RangeError,M=new C("Insufficient data"),F=new U,D=function(){function t(t){var e,r,n,o,i,s,a;this.totalPos=0,this.pos=0,this.view=P,this.bytes=_,this.headByte=-1,this.stack=[],this.extensionCodec=null!==(e=null==t?void 0:t.extensionCodec)&&void 0!==e?e:k.defaultCodec,this.context=null==t?void 0:t.context,this.useBigInt64=null!==(r=null==t?void 0:t.useBigInt64)&&void 0!==r&&r,this.maxStrLength=null!==(n=null==t?void 0:t.maxStrLength)&&void 0!==n?n:g,this.maxBinLength=null!==(o=null==t?void 0:t.maxBinLength)&&void 0!==o?o:g,this.maxArrayLength=null!==(i=null==t?void 0:t.maxArrayLength)&&void 0!==i?i:g,this.maxMapLength=null!==(s=null==t?void 0:t.maxMapLength)&&void 0!==s?s:g,this.maxExtLength=null!==(a=null==t?void 0:t.maxExtLength)&&void 0!==a?a:g,this.keyDecoder=void 0!==(null==t?void 0:t.keyDecoder)?t.keyDecoder:F}return t.prototype.reinitializeState=function(){this.totalPos=0,this.headByte=-1,this.stack.length=0},t.prototype.setBuffer=function(t){this.bytes=x(t),this.view=function(t){if(t instanceof ArrayBuffer)return new DataView(t);var e=x(t);return new DataView(e.buffer,e.byteOffset,e.byteLength)}(this.bytes),this.pos=0},t.prototype.appendBuffer=function(t){if(-1!==this.headByte||this.hasRemaining(1)){var e=this.bytes.subarray(this.pos),r=x(t),n=new Uint8Array(e.length+r.length);n.set(e),n.set(r,e.length),this.setBuffer(n)}else this.setBuffer(t)},t.prototype.hasRemaining=function(t){return this.view.byteLength-this.pos>=t},t.prototype.createExtraByteError=function(t){var e=this.view,r=this.pos;return new RangeError("Extra ".concat(e.byteLength-r," of ").concat(e.byteLength," byte(s) found at buffer[").concat(t,"]"))},t.prototype.decode=function(t){this.reinitializeState(),this.setBuffer(t);var e=this.doDecodeSync();if(this.hasRemaining(1))throw this.createExtraByteError(this.pos);return e},t.prototype.decodeMulti=function(t){return A(this,(function(e){switch(e.label){case 0:this.reinitializeState(),this.setBuffer(t),e.label=1;case 1:return this.hasRemaining(1)?[4,this.doDecodeSync()]:[3,3];case 2:return e.sent(),[3,1];case 3:return[2]}}))},t.prototype.decodeAsync=function(t){var e,r,n,o,i,s,a;return I(this,void 0,void 0,(function(){var c,u,f,l,h,p,y,d;return A(this,(function(v){switch(v.label){case 0:c=!1,v.label=1;case 1:v.trys.push([1,6,7,12]),e=!0,r=O(t),v.label=2;case 2:return[4,r.next()];case 3:if(n=v.sent(),o=n.done)return[3,5];a=n.value,e=!1;try{if(f=a,c)throw this.createExtraByteError(this.totalPos);this.appendBuffer(f);try{u=this.doDecodeSync(),c=!0}catch(t){if(!(t instanceof C))throw t}this.totalPos+=this.pos}finally{e=!0}v.label=4;case 4:return[3,2];case 5:return[3,12];case 6:return l=v.sent(),i={error:l},[3,12];case 7:return v.trys.push([7,,10,11]),e||o||!(s=r.return)?[3,9]:[4,s.call(r)];case 8:v.sent(),v.label=9;case 9:return[3,11];case 10:if(i)throw i.error;return[7];case 11:return[7];case 12:if(c){if(this.hasRemaining(1))throw this.createExtraByteError(this.totalPos);return[2,u]}throw p=(h=this).headByte,y=h.pos,d=h.totalPos,new RangeError("Insufficient data in parsing ".concat(E(p)," at ").concat(d," (").concat(y," in the current buffer)"))}}))}))},t.prototype.decodeArrayStream=function(t){return this.decodeMultiAsync(t,!0)},t.prototype.decodeStream=function(t){return this.decodeMultiAsync(t,!1)},t.prototype.decodeMultiAsync=function(t,e){return j(this,arguments,(function(){var r,n,o,i,s,a,c,u,f,l,h,p;return A(this,(function(y){switch(y.label){case 0:r=e,n=-1,y.label=1;case 1:y.trys.push([1,15,16,21]),o=!0,i=O(t),y.label=2;case 2:return[4,L(i.next())];case 3:if(s=y.sent(),f=s.done)return[3,14];p=s.value,o=!1,y.label=4;case 4:if(y.trys.push([4,,12,13]),a=p,e&&0===n)throw this.createExtraByteError(this.totalPos);this.appendBuffer(a),r&&(n=this.readArraySize(),r=!1,this.complete()),y.label=5;case 5:y.trys.push([5,10,,11]),y.label=6;case 6:return[4,L(this.doDecodeSync())];case 7:return[4,y.sent()];case 8:return y.sent(),0==--n?[3,9]:[3,6];case 9:return[3,11];case 10:if(!((c=y.sent())instanceof C))throw c;return[3,11];case 11:return this.totalPos+=this.pos,[3,13];case 12:return o=!0,[7];case 13:return[3,2];case 14:return[3,21];case 15:return u=y.sent(),l={error:u},[3,21];case 16:return y.trys.push([16,,19,20]),o||f||!(h=i.return)?[3,18]:[4,L(h.call(i))];case 17:y.sent(),y.label=18;case 18:return[3,20];case 19:if(l)throw l.error;return[7];case 20:return[7];case 21:return[2]}}))}))},t.prototype.doDecodeSync=function(){t:for(;;){var t=this.readHeadByte(),e=void 0;if(t>=224)e=t-256;else if(t<192)if(t<128)e=t;else if(t<144){if(0!==(n=t-128)){this.pushMapState(n),this.complete();continue t}e={}}else if(t<160){if(0!==(n=t-144)){this.pushArrayState(n),this.complete();continue t}e=[]}else{var r=t-160;e=this.decodeUtf8String(r,0)}else if(192===t)e=null;else if(194===t)e=!1;else if(195===t)e=!0;else if(202===t)e=this.readF32();else if(203===t)e=this.readF64();else if(204===t)e=this.readU8();else if(205===t)e=this.readU16();else if(206===t)e=this.readU32();else if(207===t)e=this.useBigInt64?this.readU64AsBigInt():this.readU64();else if(208===t)e=this.readI8();else if(209===t)e=this.readI16();else if(210===t)e=this.readI32();else if(211===t)e=this.useBigInt64?this.readI64AsBigInt():this.readI64();else if(217===t){r=this.lookU8();e=this.decodeUtf8String(r,1)}else if(218===t){r=this.lookU16();e=this.decodeUtf8String(r,2)}else if(219===t){r=this.lookU32();e=this.decodeUtf8String(r,4)}else if(220===t){if(0!==(n=this.readU16())){this.pushArrayState(n),this.complete();continue t}e=[]}else if(221===t){if(0!==(n=this.readU32())){this.pushArrayState(n),this.complete();continue t}e=[]}else if(222===t){if(0!==(n=this.readU16())){this.pushMapState(n),this.complete();continue t}e={}}else if(223===t){if(0!==(n=this.readU32())){this.pushMapState(n),this.complete();continue t}e={}}else if(196===t){var n=this.lookU8();e=this.decodeBinary(n,1)}else if(197===t){n=this.lookU16();e=this.decodeBinary(n,2)}else if(198===t){n=this.lookU32();e=this.decodeBinary(n,4)}else if(212===t)e=this.decodeExtension(1,0);else if(213===t)e=this.decodeExtension(2,0);else if(214===t)e=this.decodeExtension(4,0);else if(215===t)e=this.decodeExtension(8,0);else if(216===t)e=this.decodeExtension(16,0);else if(199===t){n=this.lookU8();e=this.decodeExtension(n,1)}else if(200===t){n=this.lookU16();e=this.decodeExtension(n,2)}else{if(201!==t)throw new v("Unrecognized type byte: ".concat(E(t)));n=this.lookU32();e=this.decodeExtension(n,4)}this.complete();for(var o=this.stack;o.length>0;){var i=o[o.length-1];if(i.type===T){if(i.array[i.position]=e,i.position++,i.position!==i.size)continue t;o.pop(),e=i.array}else{if(i.type===B){if("string"!=typeof(s=e)&&"number"!=typeof s)throw new v("The type of key must be string or number but "+typeof e);if("__proto__"===e)throw new v("The key __proto__ is not allowed");i.key=e,i.type="map_value";continue t}if(i.map[i.key]=e,i.readCount++,i.readCount!==i.size){i.key=null,i.type=B;continue t}o.pop(),e=i.map}}return e}var s},t.prototype.readHeadByte=function(){return-1===this.headByte&&(this.headByte=this.readU8()),this.headByte},t.prototype.complete=function(){this.headByte=-1},t.prototype.readArraySize=function(){var t=this.readHeadByte();switch(t){case 220:return this.readU16();case 221:return this.readU32();default:if(t<160)return t-144;throw new v("Unrecognized array type byte: ".concat(E(t)))}},t.prototype.pushMapState=function(t){if(t>this.maxMapLength)throw new v("Max length exceeded: map length (".concat(t,") > maxMapLengthLength (").concat(this.maxMapLength,")"));this.stack.push({type:B,size:t,key:null,readCount:0,map:{}})},t.prototype.pushArrayState=function(t){if(t>this.maxArrayLength)throw new v("Max length exceeded: array length (".concat(t,") > maxArrayLength (").concat(this.maxArrayLength,")"));this.stack.push({type:T,size:t,array:new Array(t),position:0})},t.prototype.decodeUtf8String=function(t,e){var r;if(t>this.maxStrLength)throw new v("Max length exceeded: UTF-8 byte length (".concat(t,") > maxStrLength (").concat(this.maxStrLength,")"));if(this.bytes.byteLength<this.pos+e+t)throw M;var n,o=this.pos+e;return n=this.stateIsMapKey()&&(null===(r=this.keyDecoder)||void 0===r?void 0:r.canBeCached(t))?this.keyDecoder.decode(this.bytes,o,t):h(this.bytes,o,t),this.pos+=e+t,n},t.prototype.stateIsMapKey=function(){return this.stack.length>0&&this.stack[this.stack.length-1].type===B},t.prototype.decodeBinary=function(t,e){if(t>this.maxBinLength)throw new v("Max length exceeded: bin length (".concat(t,") > maxBinLength (").concat(this.maxBinLength,")"));if(!this.hasRemaining(t+e))throw M;var r=this.pos+e,n=this.bytes.subarray(r,r+t);return this.pos+=e+t,n},t.prototype.decodeExtension=function(t,e){if(t>this.maxExtLength)throw new v("Max length exceeded: ext length (".concat(t,") > maxExtLength (").concat(this.maxExtLength,")"));var r=this.view.getInt8(this.pos+e),n=this.decodeBinary(t,e+1);return this.extensionCodec.decode(n,r,this.context)},t.prototype.lookU8=function(){return this.view.getUint8(this.pos)},t.prototype.lookU16=function(){return this.view.getUint16(this.pos)},t.prototype.lookU32=function(){return this.view.getUint32(this.pos)},t.prototype.readU8=function(){var t=this.view.getUint8(this.pos);return this.pos++,t},t.prototype.readI8=function(){var t=this.view.getInt8(this.pos);return this.pos++,t},t.prototype.readU16=function(){var t=this.view.getUint16(this.pos);return this.pos+=2,t},t.prototype.readI16=function(){var t=this.view.getInt16(this.pos);return this.pos+=2,t},t.prototype.readU32=function(){var t=this.view.getUint32(this.pos);return this.pos+=4,t},t.prototype.readI32=function(){var t=this.view.getInt32(this.pos);return this.pos+=4,t},t.prototype.readU64=function(){var t,e,r=(t=this.view,e=this.pos,4294967296*t.getUint32(e)+t.getUint32(e+4));return this.pos+=8,r},t.prototype.readI64=function(){var t=w(this.view,this.pos);return this.pos+=8,t},t.prototype.readU64AsBigInt=function(){var t=this.view.getBigUint64(this.pos);return this.pos+=8,t},t.prototype.readI64AsBigInt=function(){var t=this.view.getBigInt64(this.pos);return this.pos+=8,t},t.prototype.readF32=function(){var t=this.view.getFloat32(this.pos);return this.pos+=4,t},t.prototype.readF64=function(){var t=this.view.getFloat64(this.pos);return this.pos+=8,t},t}();function N(){N=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function f(t,e,r,n){var i=e&&e.prototype instanceof g?e:g,s=Object.create(i.prototype),a=new j(n||[]);return o(s,"_invoke",{value:I(t,r,a)}),s}function l(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=f;var h="suspendedStart",p="suspendedYield",y="executing",d="completed",v={};function g(){}function m(){}function w(){}var b={};u(b,s,(function(){return this}));var k=Object.getPrototypeOf,x=k&&k(k(T([])));x&&x!==r&&n.call(x,s)&&(b=x);var S=w.prototype=g.prototype=Object.create(b);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function U(t,e){function r(o,i,s,a){var c=l(t[o],t,i);if("throw"!==c.type){var u=c.arg,f=u.value;return f&&"object"==W(f)&&n.call(f,"__await")?e.resolve(f.__await).then((function(t){r("next",t,s,a)}),(function(t){r("throw",t,s,a)})):e.resolve(f).then((function(t){u.value=t,s(u)}),(function(t){return r("throw",t,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=h;return function(i,s){if(o===y)throw Error("Generator is already running");if(o===d){if("throw"===i)throw s;return{value:t,done:!0}}for(n.method=i,n.arg=s;;){var a=n.delegate;if(a){var c=A(a,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=y;var u=l(e,r,n);if("normal"===u.type){if(o=n.done?d:p,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=d,n.method="throw",n.arg=u.arg)}}}function A(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,A(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=l(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var s=i.arg;return s?s.done?(r[e.resultName]=s.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function j(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function T(e){if(e||""===e){var r=e[s];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(W(e)+" is not iterable")}return m.prototype=w,o(S,"constructor",{value:w,configurable:!0}),o(w,"constructor",{value:m,configurable:!0}),m.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===m||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(S),t},e.awrap=function(t){return{__await:t}},E(U.prototype),u(U.prototype,a,(function(){return this})),e.AsyncIterator=U,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var s=new U(f(t,r,n,o),i);return e.isGeneratorFunction(r)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},E(S),u(S,c,"Generator"),u(S,s,(function(){return this})),u(S,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=T,j.prototype={constructor:j,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(L),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=n.call(s,"catchLoc"),u=n.call(s,"finallyLoc");if(c&&u){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=t,s.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),L(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;L(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:T(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}function W(t){return W="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},W(t)}function z(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,R(n.key),n)}}function R(t){var e=function(t,e){if("object"!=W(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=W(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==W(e)?e:e+""}function G(t,e,r,n,o,i,s){try{var a=t[i](s),c=a.value}catch(t){return void r(t)}a.done?e(c):Promise.resolve(c).then(n,o)}function V(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function s(t){G(i,n,o,s,a,"next",t)}function a(t){G(i,n,o,s,a,"throw",t)}s(void 0)}))}}function q(t){switch(t){case"Number":return"int";case"Boolean":return"bool";case"String":return"str";case"Array":return"list";case"Object":return"dict";case"ArrayBuffer":case"Blob":return"bytes";case"t":return"ndarray";default:return t}}function K(t){return new Promise((function(e,r){var n=new FileReader;n.onload=function(){e(new Uint8Array(n.result)),n.close()},n.onerror=function(){r(n.error),n.close()},n.readAsArrayBuffer(t)}))}function $(t){return H.apply(this,arguments)}function H(){return H=V(N().mark((function t(e){var r,n=arguments;return N().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=3,K(e);case 3:return r=t.sent,t.abrupt("return",{type:"bytes",data:r,dtype:e.type});case 5:case"end":return t.stop()}}),t)}))),H.apply(this,arguments)}function J(t){return new Promise((function(e,r){var n=document.createElement("canvas"),o=n.getContext("2d"),i=function(t){var e=t.src;if(e)return e.startsWith("data")?e.split(";")[0].split(":")[1]:e.endsWith(".png")?"image/png":e.endsWith(".jpg")||e.endsWith(".jpeg")?"image/jpeg":e.endsWith(".gif")?"image/gif":e.endsWith(".bmp")?"image/bmp":"image/png"}(t);n.width=datum.width,n.height=datum.height,o.drawImage(datum,0,0),n.toBlob((function(t){$(t,i).then(e).catch(r)}),i)}))}var Y=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t)}return e=t,r=null,n=[{key:"pack",value:(c=V(N().mark((function e(r){var n,o,i,s,c,u,f;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=r){e.next=4;break}return e.abrupt("return",{type:"null"});case 4:if(!(r instanceof ArrayBuffer)){e.next=8;break}return e.abrupt("return",{type:"bytes",data:new Uint8Array(r)});case 8:if(!(r instanceof Blob)){e.next=14;break}return e.next=11,$(r);case 11:case 25:return e.abrupt("return",e.sent);case 14:if(!(r instanceof a)){e.next=18;break}return e.abrupt("return",r.packed);case 18:if(!a.isTypedArray(r)){e.next=22;break}return e.abrupt("return",new a(r).packed);case 22:if(!("undefined"!=typeof Image&&r instanceof Image)){e.next=28;break}return e.next=25,J(r);case 28:if("function"!=typeof r){e.next=32;break}return e.abrupt("return",{type:"type",dtype:q(r.name)});case 32:if("number"!=typeof r){e.next=36;break}return e.abrupt("return",{type:r%1==0?"int":"float",data:r});case 36:if("boolean"!=typeof r){e.next=40;break}return e.abrupt("return",{type:"bool",data:r});case 40:if("string"!=typeof r){e.next=45;break}return n=new TextEncoder("utf-8"),e.abrupt("return",{type:"str",data:n.encode(r)});case 45:if(!Array.isArray(r)){e.next=52;break}return e.next=48,Promise.all(r.map(t.pack));case 48:return e.t0=e.sent,e.abrupt("return",{type:"list",items:e.t0});case 52:if("object"!==W(r)){e.next=64;break}for(s in o=Object.keys(r),i=[],r)i.push(t.pack(r[s]));return e.next=58,Promise.all(i);case 58:for(c=e.sent,u={},f=0;f<o.length;f++)u[o[f]]=c[f];return e.abrupt("return",{type:"dict",props:u});case 64:throw new Error("Unsupported datum type: ${typeof datum} (${datum.constructor.name})");case 65:case"end":return e.stop()}}),e)}))),function(t){return c.apply(this,arguments)})},{key:"unpack",value:(s=V(N().mark((function e(r){return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){switch(r.type){case"null":return e(null);case"int":case"float":case"bool":return e(r.data);case"bytes":return e(r.data.buffer);case"str":var o=new TextDecoder("utf-8");return e(o.decode(r.data));case"list":return Promise.all(r.items.map(t.unpack)).then(e).catch(n);case"dict":var i=[],s=[];for(var c in r.props)i.push(c),s.push(t.unpack(r.props[c]));return Promise.all(s).then((function(t){for(var r={},n=0;n<i.length;n++)r[i[n]]=t[n];e(r)})).catch(n);case"ndarray":case"tensor":return e(new a(r.data,r.shape,r.dtype));case"image":if("undefined"==typeof Image)return n(new Error("Image is not supported in this environment."));var u=new Blob([r.data],{type:"image/".concat(r.dtype)}),f=URL.createObjectURL(u),l=new Image;return l.addEventListener("load",(function(){e(l)})),l.src=f,l;case"audio":var h=new Blob([r.data],{type:"audio/".concat(r.dtype)}),p=URL.createObjectURL(h),y=new Audio;return y.addEventListener("loadeddata",(function(){e(y)})),y.src=p,y;case"exception":var d=new TextDecoder("utf-8").decode(r.data);return e(new Error("".concat(r.dtype,": ").concat(d)));default:console.error("Unhandled response type",r),n(new Error("Unsupported packed type: ".concat(r.type)))}})));case 1:case"end":return e.stop()}}),e)}))),function(t){return s.apply(this,arguments)})},{key:"encode",value:(i=V(N().mark((function e(r){var n;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.pack(r);case 2:return n=e.sent,e.abrupt("return",(o=n,new S(void 0).encodeSharedRef(o)));case 4:case"end":return e.stop()}var o}),e)}))),function(t){return i.apply(this,arguments)})},{key:"decode",value:(o=V(N().mark((function e(r){var n;return N().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=r,n=new D(void 0).decode(o),e.next=3,t.unpack(n);case 3:return e.abrupt("return",e.sent);case 4:case"end":return e.stop()}var o}),e)}))),function(t){return o.apply(this,arguments)})}],r&&z(e.prototype,r),n&&z(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,r,n,o,i,s,c}();function Q(t){return Q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Q(t)}function X(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Z(n.key),n)}}function Z(t){var e=function(t,e){if("object"!=Q(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=Q(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Q(e)?e:e+""}var tt=function(){return t=function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.holder=Promise.resolve()},(e=[{key:"acquire",value:function(){var t,e=new Promise((function(e){t=function(){return e()}})),r=this.holder.then((function(){return t}));return this.holder=e,r}}])&&X(t.prototype,e),r&&X(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,r}();function et(t){return et="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},et(t)}var rt=function(t){return null==t||""===t||"null"===t||Array.isArray(t)&&0===t.length||"object"===et(t)&&"Object"===t.constructor.name&&0===Object.getOwnPropertyNames(t).length},nt=function(){return"10000000-1000-4000-8000-100000000000".replace(/[018]/g,(function(t){return(+t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>+t/4).toString(16)}))},ot=function(t){var e=t.reduce((function(t,e){return t+e.length}),0),r=new t[0].constructor(e),n=0;return t.forEach((function(t){r.set(t,n),n+=t.length})),r};function it(t){return it="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},it(t)}function st(t,e,r){return e=ft(e),function(t,e){if(e&&("object"==it(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,at()?Reflect.construct(e,r||[],ft(t).constructor):e.apply(t,r))}function at(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(at=function(){return!!t})()}function ct(t,e,r,n){var o=ut(ft(1&n?t.prototype:t),e,r);return 2&n&&"function"==typeof o?function(t){return o.apply(r,t)}:o}function ut(){return ut="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=ft(t)););return t}(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(arguments.length<3?t:r):o.value}},ut.apply(null,arguments)}function ft(t){return ft=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},ft(t)}function lt(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&ht(t,e)}function ht(t,e){return ht=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},ht(t,e)}function pt(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=dt(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){a=!0,i=t},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw i}}}}function yt(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var r=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=r){var n,o,i,s,a=[],c=!0,u=!1;try{if(i=(r=r.call(t)).next,0===e){if(Object(r)!==r)return;c=!1}else for(;!(c=(n=i.call(r)).done)&&(a.push(n.value),a.length!==e);c=!0);}catch(t){u=!0,o=t}finally{try{if(!c&&null!=r.return&&(s=r.return(),Object(s)!==s))return}finally{if(u)throw o}}return a}}(t,e)||dt(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function dt(t,e){if(t){if("string"==typeof t)return vt(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?vt(t,e):void 0}}function vt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function gt(t,e,r,n,o,i,s){try{var a=t[i](s),c=a.value}catch(t){return void r(t)}a.done?e(c):Promise.resolve(c).then(n,o)}function mt(t){return function(){var e=this,r=arguments;return new Promise((function(n,o){var i=t.apply(e,r);function s(t){gt(i,n,o,s,a,"next",t)}function a(t){gt(i,n,o,s,a,"throw",t)}s(void 0)}))}}function wt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function bt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,xt(n.key),n)}}function kt(t,e,r){return e&&bt(t.prototype,e),r&&bt(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function xt(t){var e=function(t,e){if("object"!=it(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=it(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==it(e)?e:e+""}function St(){St=function(){return e};var t,e={},r=Object.prototype,n=r.hasOwnProperty,o=Object.defineProperty||function(t,e,r){t[e]=r.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function u(t,e,r){return Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,r){return t[e]=r}}function f(t,e,r,n){var i=e&&e.prototype instanceof g?e:g,s=Object.create(i.prototype),a=new j(n||[]);return o(s,"_invoke",{value:I(t,r,a)}),s}function l(t,e,r){try{return{type:"normal",arg:t.call(e,r)}}catch(t){return{type:"throw",arg:t}}}e.wrap=f;var h="suspendedStart",p="suspendedYield",y="executing",d="completed",v={};function g(){}function m(){}function w(){}var b={};u(b,s,(function(){return this}));var k=Object.getPrototypeOf,x=k&&k(k(T([])));x&&x!==r&&n.call(x,s)&&(b=x);var S=w.prototype=g.prototype=Object.create(b);function E(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function U(t,e){function r(o,i,s,a){var c=l(t[o],t,i);if("throw"!==c.type){var u=c.arg,f=u.value;return f&&"object"==it(f)&&n.call(f,"__await")?e.resolve(f.__await).then((function(t){r("next",t,s,a)}),(function(t){r("throw",t,s,a)})):e.resolve(f).then((function(t){u.value=t,s(u)}),(function(t){return r("throw",t,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(t,n){function o(){return new e((function(e,o){r(t,n,e,o)}))}return i=i?i.then(o,o):o()}})}function I(e,r,n){var o=h;return function(i,s){if(o===y)throw Error("Generator is already running");if(o===d){if("throw"===i)throw s;return{value:t,done:!0}}for(n.method=i,n.arg=s;;){var a=n.delegate;if(a){var c=A(a,n);if(c){if(c===v)continue;return c}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(o===h)throw o=d,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);o=y;var u=l(e,r,n);if("normal"===u.type){if(o=n.done?d:p,u.arg===v)continue;return{value:u.arg,done:n.done}}"throw"===u.type&&(o=d,n.method="throw",n.arg=u.arg)}}}function A(e,r){var n=r.method,o=e.iterator[n];if(o===t)return r.delegate=null,"throw"===n&&e.iterator.return&&(r.method="return",r.arg=t,A(e,r),"throw"===r.method)||"return"!==n&&(r.method="throw",r.arg=new TypeError("The iterator does not provide a '"+n+"' method")),v;var i=l(o,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,v;var s=i.arg;return s?s.done?(r[e.resultName]=s.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,v):s:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,v)}function O(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function L(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function j(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(O,this),this.reset(!0)}function T(e){if(e||""===e){var r=e[s];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var o=-1,i=function r(){for(;++o<e.length;)if(n.call(e,o))return r.value=e[o],r.done=!1,r;return r.value=t,r.done=!0,r};return i.next=i}}throw new TypeError(it(e)+" is not iterable")}return m.prototype=w,o(S,"constructor",{value:w,configurable:!0}),o(w,"constructor",{value:m,configurable:!0}),m.displayName=u(w,c,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===m||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,w):(t.__proto__=w,u(t,c,"GeneratorFunction")),t.prototype=Object.create(S),t},e.awrap=function(t){return{__await:t}},E(U.prototype),u(U.prototype,a,(function(){return this})),e.AsyncIterator=U,e.async=function(t,r,n,o,i){void 0===i&&(i=Promise);var s=new U(f(t,r,n,o),i);return e.isGeneratorFunction(r)?s:s.next().then((function(t){return t.done?t.value:s.next()}))},E(S),u(S,c,"Generator"),u(S,s,(function(){return this})),u(S,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),r=[];for(var n in e)r.push(n);return r.reverse(),function t(){for(;r.length;){var n=r.pop();if(n in e)return t.value=n,t.done=!1,t}return t.done=!0,t}},e.values=T,j.prototype={constructor:j,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(L),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function o(n,o){return a.type="throw",a.arg=e,r.next=n,o&&(r.method="next",r.arg=t),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=n.call(s,"catchLoc"),u=n.call(s,"finallyLoc");if(c&&u){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(t,e){for(var r=this.tryEntries.length-1;r>=0;--r){var o=this.tryEntries[r];if(o.tryLoc<=this.prev&&n.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=e&&e<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=t,s.arg=e,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(s)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),v},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),L(r),v}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var r=this.tryEntries[e];if(r.tryLoc===t){var n=r.completion;if("throw"===n.type){var o=n.arg;L(r)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:T(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),v}},e}var Et=St().mark(Ut);function Ut(t,e){var r;return St().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=0;case 1:if(!(r<t.length)){n.next=7;break}return n.next=4,t.slice(r,r+e);case 4:r+=e,n.next=1;break;case 7:case"end":return n.stop()}}),Et)}var It=function(){return kt((function t(e){var r=arguments.length>1&&void 0!==arguments[1]&&arguments[1];wt(this,t),this.socket=null,this.address=e,this.lock=new tt,this.debug=r,this.messageLength=null,this.messageBuffer=[],this.messageListeners=[],this.errorListeners=[]}),[{key:"isWebsocket",get:function(){return this.address.startsWith("ws://")||this.address.startsWith("wss://")}},{key:"getWebsocket",value:function(){var t=this;return new Promise((function(e,r){t.lock.acquire().then((function(n){try{if(null!==t.socket&&void 0!==t.socket){if(t.socket.readyState===WebSocket.OPEN)return void e(t.socket);t.socket.readyState!==WebSocket.CONNECTING&&t.close()}if(null!==t.socket&&void 0!==t.socket)throw new Error("WebSocket connection is in state ".concat(t.socket.readyState,"."));t.socket=new WebSocket(t.address),t.socket.binaryType="arraybuffer",t.socket.addEventListener("open",(function(){e(t.socket)})),t.socket.addEventListener("message",function(){var e=mt(St().mark((function e(r){return St().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.pushMessageChunk(r.data);case 2:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),t.socket.addEventListener("error",(function(e){t.dispatchError(e)}))}catch(e){if(console.error("Error getting WebSocket connection:",e),null!==t.socket&&void 0!==t.socket){try{t.socket.close()}catch(t){}delete t.socket}t.dispatchError(e),r(e)}finally{n()}}))}))}},{key:"close",value:function(){var t=this;this.socket&&this.socket.readyState===WebSocket.OPEN&&this.lock.acquire().then((function(e){t.socket.close(),delete t.socket,e()}))}},{key:"address",get:function(){return this.url},set:function(t){this.url=t,this.socket&&this.socket.url===t||this.close()}},{key:"pushMessageChunk",value:(t=mt(St().mark((function t(e){var r;return St().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(null===this.messageLength&&e.byteLength>=4&&(this.messageLength=new DataView(e).getUint32(0),e=e.slice(4)),this.messageBuffer.push(new Uint8Array(e)),r=this.messageBuffer.reduce((function(t,e){return t+e.byteLength}),0),!(null!==this.messageLength&&r>=this.messageLength)){t.next=19;break}if(1!==this.messageBuffer.length){t.next=12;break}return t.t0=this,t.next=8,Y.decode(this.messageBuffer[0]);case 8:t.t1=t.sent,t.t0.dispatchMessage.call(t.t0,t.t1),t.next=17;break;case 12:return t.t2=this,t.next=15,Y.decode(ot(this.messageBuffer));case 15:t.t3=t.sent,t.t2.dispatchMessage.call(t.t2,t.t3);case 17:this.messageLength=null,this.messageBuffer=[];case 19:case"end":return t.stop()}}),t,this)}))),function(e){return t.apply(this,arguments)})},{key:"onMessage",value:function(t){this.messageListeners.push(t)}},{key:"onError",value:function(t){this.errorListeners.push(t)}},{key:"offMessage",value:function(t){this.messageListeners=this.messageListeners.filter((function(e){return e!==t}))}},{key:"offError",value:function(t){this.errorListeners=this.errorListeners.filter((function(e){return e!==t}))}},{key:"dispatchMessage",value:function(t){this.debug&&console.log("Received message:",t),this.messageListeners.forEach((function(e){return e(t)}))}},{key:"dispatchError",value:function(t){this.debug&&console.error("Received error:",t),this.errorListeners.forEach((function(e){return e(t)}))}},{key:"send",value:function(t){var e=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return this.debug&&console.log("Sending message:",t,"to",this.address),new Promise(function(){var n=mt(St().mark((function n(o,i){var s,a,c,u,f,l,h,p,y,d,v,g,m,w,b,k;return St().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(n.prev=0,!e.isWebsocket){n.next=37;break}return n.next=4,Promise.all([e.getWebsocket(),Y.encode(t)]);case 4:s=n.sent,a=yt(s,2),c=a[0],u=a[1],r&&(f=function(t){o(t),e.offMessage(f)},l=function(t){i(t),e.offError(l)},e.onMessage(f),e.onError(l)),h=new Uint8Array(new ArrayBuffer(4)),p=!1,new DataView(h.buffer).setUint32(0,u.length),y=pt(Ut(u,1048576)),n.prev=12,y.s();case 14:if((d=y.n()).done){n.next=26;break}if(v=d.value,p){n.next=22;break}return n.next=19,c.send(ot([h,v]));case 19:p=!0,n.next=24;break;case 22:return n.next=24,c.send(v);case 24:n.next=14;break;case 26:n.next=31;break;case 28:n.prev=28,n.t0=n.catch(12),y.e(n.t0);case 31:return n.prev=31,y.f(),n.finish(31);case 34:r||o(),n.next=57;break;case 37:return n.next=39,Y.encode(t);case 39:return g=n.sent,n.next=42,fetch(e.address,{method:"POST",body:g,headers:{"Content-Type":"application/octet-stream"}});case 42:if(!(m=n.sent).ok){n.next=54;break}return n.next=46,m.arrayBuffer();case 46:return w=n.sent,n.next=49,Y.decode(new Uint8Array(w));case 49:b=n.sent,e.dispatchMessage(b),o(b),n.next=57;break;case 54:k=new Error("Error sending message: ".concat(m.statusText)),e.dispatchError(k),i(k);case 57:n.next=62;break;case 59:n.prev=59,n.t1=n.catch(0),i(n.t1);case 62:case"end":return n.stop()}}),n,null,[[0,59],[12,28,31,34]])})));return function(t,e){return n.apply(this,arguments)}}())}}]);var t}(),At=function(t){function e(){return wt(this,e),st(this,e,arguments)}return lt(e,t),kt(e,[{key:"send",value:function(t){var r,n=this,o=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if("string"==typeof t)return ct(e,"send",this,3)([t,o]);if(!t instanceof Object)throw new Error("Message must be an object.");if(void 0!==t.request&&null!==t.request&&void 0!==t.request.id)r=t.request.id;else{if(void 0===t.id)throw new Error("Message must have an ID.");r=t.id}return o?new Promise((function(o,i){var s=function(t){t instanceof Error?i(t):t.id===r&&(o(t),n.offMessage(s))},a=function(t){i(t),n.offError(a),n.offMessage(s)};n.onMessage(s),n.onError(a),ct(e,"send",n,3)([t,!1])})):ct(e,"send",this,3)([t,!1])}}])}(It);function Ot(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return Lt(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?Lt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){a=!0,i=t},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw i}}}}function Lt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function jt(t){return jt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},jt(t)}function Tt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Bt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,_t(n.key),n)}}function Pt(t,e,r){return e&&Bt(t.prototype,e),r&&Bt(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function _t(t){var e=function(t,e){if("object"!=jt(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=jt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==jt(e)?e:e+""}var Ct=function(){return Pt((function t(e){Tt(this,t),this.driver=e,this.scopes={}}),[{key:"getScope",value:function(t,e){return this.scopes.hasOwnProperty(t)||(this.scopes[t]=new Mt(t,this.driver,e)),this.scopes[t]}},{key:"getAll",value:function(){return Object.getOwnPropertyNames(this.scopes).reduce((function(t,e){return t[e]=storage.getScope(e).getAll(),t}),{})}},{key:"clear",value:function(){for(var t in this.scopes)this.getScope(t).clear()}}])}(),Mt=function(){return Pt((function t(e,r,n){Tt(this,t),this.scope=e,this.driver=r,this.ttl=n,void 0===this.ttl&&(this.ttl=36e5)}),[{key:"getAll",value:function(){return this.keys().reduce((function(t,e){return t[e]=storage.getItem(e),t}),{})}},{key:"setItem",value:function(t,e){var r="".concat(this.scope,"-").concat(t),n="".concat(this.scope,"-").concat(t,"-expiration");this.driver.setItem(r,JSON.stringify(e)),this.driver.setItem(n,(new Date).getTime()+this.ttl)}},{key:"getItem",value:function(t){var e="".concat(this.scope,"-").concat(t),r="".concat(this.scope,"-").concat(t,"-expiration"),n=this.driver.getItem(e),o=this.driver.getItem(r);if(void 0!==n&&"undefined"!==n)return null===n||"null"===n?null:(n=JSON.parse(n),!rt(o)&&o<=(new Date).getTime()?(this.removeItem(e),null):n)}},{key:"keys",value:function(){var t="".concat(this.scope,"-");return(void 0!==this.driver.keys?this.driver.keys():Object.getOwnPropertyNames(this.driver)).filter((function(e){return e.startsWith(t)})).map((function(e){return e.substring(t.length)})).filter((function(t){return"expiration"!=t}))}},{key:"removeItem",value:function(t){var e="".concat(this.scope,"-").concat(t);return this.driver.removeItem(e)}},{key:"removePrefix",value:function(t){var e,r=Ot(this.keys());try{for(r.s();!(e=r.n()).done;){var n=e.value;n.startsWith(t)&&this.removeItem(n)}}catch(t){r.e(t)}finally{r.f()}}},{key:"clear",value:function(){var t,e=Ot(this.keys());try{for(e.s();!(t=e.n()).done;){var r=t.value;this.removeItem(r)}}catch(t){e.e(t)}finally{e.f()}return this.setItem("expiration",{}),this.driver.clear()}},{key:"key",value:function(t){return this.keys()[t]}}])}(),Ft=function(){return Pt((function t(){Tt(this,t),this.expiration=new Date,this.expiration.setTime(this.expiration.getTime()+2592e6)}),[{key:"keys",value:function(){var t,e,r=[],n=Ot(decodeURIComponent(document.cookie).split(";"));try{for(n.s();!(e=n.n()).done;){for(t=e.value.split("=")[0];" "==t.charAt(0);)t=t.substring(1);r.push(t)}}catch(t){n.e(t)}finally{n.f()}return r}},{key:"getItem",value:function(t){var e,r=Ot(decodeURIComponent(document.cookie).split(";"));try{for(r.s();!(e=r.n()).done;){for(var n=e.value;" "==n.charAt(0);)n=n.substring(1);if(n.startsWith("".concat(t,"=")))return JSON.parse(n.substring(t.length+1))}}catch(t){r.e(t)}finally{r.f()}return null}},{key:"setItem",value:function(t,e,r){void 0===r&&(r=this.expiration),document.cookie=["".concat(t,"=").concat(JSON.stringify(e)),"expires=".concat(r.toUTCString()),"path=/",""].join(";")}},{key:"removeItem",value:function(t){var e=new Date;e.setTime(0),this.setItem(t,"",e)}},{key:"clear",value:function(){var t,e=Ot(this.keys());try{for(e.s();!(t=e.n()).done;){var r=t.value;this.removeItem(r)}}catch(t){e.e(t)}finally{e.f()}}},{key:"key",value:function(t){return this.keys()[t]}}])}(),Dt=function(){return Pt((function t(){Tt(this,t),this.storage={}}),[{key:"keys",value:function(){return Object.getOwnPropertyNames(this.storage)}},{key:"setItem",value:function(t,e){this.storage[t]=e}},{key:"getItem",value:function(t){return this.storage.hasOwnProperty(t)?this.storage[t]:null}},{key:"removeItem",value:function(t){delete this.storage[t]}},{key:"removePrefix",value:function(t){var e,r=Ot(this.keys());try{for(r.s();!(e=r.n()).done;){var n=e.value;n.startsWith(t)&&this.removeItem(n)}}catch(t){r.e(t)}finally{r.f()}}},{key:"clear",value:function(){var t,e=Ot(this.keys);try{for(e.s();!(t=e.n()).done;){var r=t.value;delete this.storage[r]}}catch(t){e.e(t)}finally{e.f()}}},{key:"key",value:function(t){return this.keys()[t]}}])}();function Nt(t){return Nt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},Nt(t)}function Wt(t,e){var r="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!r){if(Array.isArray(t)||(r=function(t,e){if(t){if("string"==typeof t)return zt(t,e);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?zt(t,e):void 0}}(t))||e&&t&&"number"==typeof t.length){r&&(t=r);var n=0,o=function(){};return{s:o,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){r=r.call(t)},n:function(){var t=r.next();return s=t.done,t},e:function(t){a=!0,i=t},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw i}}}}function zt(t,e){(null==e||e>t.length)&&(e=t.length);for(var r=0,n=Array(e);r<e;r++)n[r]=t[r];return n}function Rt(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,Gt(n.key),n)}}function Gt(t){var e=function(t,e){if("object"!=Nt(t)||!t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var n=r.call(t,e||"default");if("object"!=Nt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==Nt(e)?e:e+""}function Vt(t,e,r){return e=$t(e),function(t,e){if(e&&("object"==Nt(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,qt()?Reflect.construct(e,r||[],$t(t).constructor):e.apply(t,r))}function qt(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(qt=function(){return!!t})()}function Kt(){return Kt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var n=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=$t(t)););return t}(t,e);if(n){var o=Object.getOwnPropertyDescriptor(n,e);return o.get?o.get.call(arguments.length<3?t:r):o.value}},Kt.apply(null,arguments)}function $t(t){return $t=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},$t(t)}function Ht(t,e){return Ht=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Ht(t,e)}var Jt=new Ct(function(){try{return"undefined"!=typeof localStorage?localStorage:"undefined"!=typeof window?new Ft:new Dt}catch(t){return console.error("Couldn't get local storage, defaulting to cookies.",t),new Ft}}()).getScope("taproot");function Yt(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null==t)return{type:"NoneType"};var e={parameter_type:t.constructor,parameter_size:1};if("undefined"!=typeof Blob&&t instanceof Blob)e.parameter_type="bytes",e.parameter_size=t.size;else if(t instanceof a)e.parameter_size=t.shape;else if(a.isTypedArray(t))t=new a(t),e.parameter_type=a,e.parameter_size=t.shape;else if("undefined"!=typeof Image&&t instanceof Image)e.parameter_size=[t.width,t.height];else if(Array.isArray(t))e.parameter_size=[t.length],e.parameter_sub_metadata=Yt(t[0]);else if(e.parameter_type===Object)for(var r in e.parameter_size=Object.keys(t).length,e.parameter_sub_metadata={},t)e.parameter_sub_metadata[r]=Yt(t[r]);else void 0!==t.length&&(e.parameter_size=t.length);return e}var Qt=function(t){function e(){return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),Vt(this,e,arguments)}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Ht(t,e)}(e,t),r=e,n=[{key:"completeAddress",get:function(){if(this.isWebsocket&&(this.address.startsWith("ws://")||this.address.startsWith("wss://"))||this.address.startsWith("http://")||this.address.startsWith("https://"))return this.address;if("undefined"!=typeof window&&void 0!==window.location){var t=window.location.href;if(this.isWebsocket&&(t=t.replace("http://","ws://").replace("https://","wss://")),!t.endsWith("/"))if(window.location.href===window.location.origin)t+="/";else{var e=t.lastIndexOf("/");t=t.substring(0,e+1)}return this.address.startsWith("/")?"".concat(t).concat(this.address.substring(1)):"".concat(t).concat(this.address)}return this.address}},{key:"clientId",get:function(){var t=Jt.getItem("clientId");if(t)return t;var e=nt();return Jt.setItem("clientId",e),e}},{key:"getClient",value:function(t){return null!==this.executors&&void 0!==this.executors||(this.executors={}),null!==this.executors[t]&&void 0!==this.executors[t]||(this.debug&&console.log("Creating new client for ".concat(t)),this.executors[t]=new At(t,this.debug)),this.executors[t]}},{key:"clearClientForTask",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;null!==this.tasks&&void 0!==this.tasks||(this.tasks={}),null!==this.tasks[t]&&void 0!==this.tasks[t]||(this.tasks[t]={}),null==e&&(e="default"),null!==this.tasks[t][e]&&void 0!==this.tasks[t][e]&&this.tasks[t][e].close(),this.tasks[t][e]=null}},{key:"setClientForTask",value:function(t,e){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;null!==this.tasks&&void 0!==this.tasks||(this.tasks={}),null!==this.tasks[e]&&void 0!==this.tasks[e]||(this.tasks[e]={}),null==r&&(r="default"),this.tasks[e][r]=t}},{key:"getClientForTask",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!==this.tasks&&void 0!==this.tasks||(this.tasks={}),null!==this.tasks[t]&&void 0!==this.tasks[t]||(this.tasks[t]={}),null==e&&(e="default"),null!==this.tasks[t][e]&&void 0!==this.tasks[t][e]?this.tasks[t][e]:null}},{key:"getLockForTask",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null!==this.locks&&void 0!==this.locks||(this.locks={}),null!==this.locks[t]&&void 0!==this.locks[t]||(this.locks[t]={}),null==e&&(e="default"),null!==this.locks[t][e]&&void 0!==this.locks[t][e]||(this.locks[t][e]=new tt),this.locks[t][e]}},{key:"sendInvocation",value:function(t,e){var r=this;e=e||{};var n=t.task,o=t.model||null,i=t.continuation,s=0,a=e.fetchIntermediates,c=e.pollingInterval||1e3,u=e.retryDelay||20,f=e.onIntermediateResult||function(t,e){return console.log("Ignored intermediate result",e,t)},l=e.onInterimResult||function(t,e){return console.log("Ignored interim result",e,t)};if(rt(n))throw new Error("Task is required.");return new Promise((function(h,p){t.id=nt(),t.client_id=r.clientId,t.overseer=r.completeAddress,t.return_metadata=!0,t.wait_for_result=!a;var y=r.getClientForTask(n,o),d=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3;return new Promise((function(n,o){var i=t.id,h=t.address,p=r.getClient(h),y=function(){return p.send({id:i,client_id:r.clientId,return_metadata:!0,wait_for_result:!a})},v=function(e){p.offError(v),p.offMessage(g),retry?d(t,!1).then(n).catch(o):(console.error("Error with continuation",i,"from",h,e),o(e))},g=function(r){if(r instanceof Error)p.offMessage(g),p.offError(v),e>0?setTimeout((function(){d(t,e-1).then(n).catch(o)}),u):(console.error("Error with continuation",i,"from",h,r),o(r));else if(r.id==i)if(["error","complete"].includes(r.status))if(p.offMessage(g),p.offError(v),"error"===r.status)o(r.result);else if(r.continuation){l(r.result,s),s++;var a=r.continuation,m=!1;Array.isArray(a)||(a=[a],m=!0);var w,b=[],k=Wt(a);try{for(k.s();!(w=k.n()).done;){var x=w.value;b.push(d(x))}}catch(t){k.e(t)}finally{k.f()}Promise.all(b).then((function(t){n(m?t[0]:t)})).catch(o)}else n(r.result);else rt(r.intermediate)||f(r.intermediate,s),setTimeout(y,c)};p.onMessage(g),p.onError(v),y()}))},v=function(){return y.send({id:t.id,client_id:r.clientId,return_metadata:!0,wait_for_result:!a})},g=function(e){if(e.id===t.id)if(["error","complete"].includes(e.status))if(y.offMessage(g),y.offError(m),i)if(l(e.result,s),s++,e.continuation&&e.continuation.id){var r=e.continuation,n=!1;Array.isArray(r)||(r=[r],n=!0);var o,a=[],u=Wt(r);try{for(u.s();!(o=u.n()).done;){var w=o.value;a.push(d(w))}}catch(t){u.e(t)}finally{u.f()}Promise.all(a).then((function(t){h(n?t[0]:t)})).catch(p)}else p("Continuation request but not found in message");else h(e.result);else rt(e.intermediate)||f(e.intermediate,s),setTimeout(v,c)},m=function(t){y.offMessage(g),y.offError(m),p(t)},w=t.parameters;if(null===y)t.parameters=function(t){var e={};for(var r in t)e[r]=Yt(t[r]);return e}(w),r.send(t).then((function(e){e.address?e.address.startsWith("tcp://")||e.address.startsWith("tcps://")||e.address.startsWith("unix://")?p("Executor is not configured for websocket communication, received: ".concat(e.address)):(t.parameters=w,(y=r.getClient(e.address)).onMessage(g),y.onError(m),y.send(t,!1),r.setClientForTask(y,n,o)):p("No address found for executor.")})).catch(p);else{r.debug&&console.log("Reusing client for task",n);var b=function(i){y.offMessage(g),y.offError(b),r.clearClientForTask(n,o),r.sendInvocation(t,e).then((function(t){h(t)})).catch((function(t){p(t)}))};t.parameters=w,y.onMessage(g),y.onError(b),y.send(t,!1)}}))}},{key:"invoke",value:function(t,e){var r=this,n=t.task,o=t.model||null;if(rt(n))throw new Error("Task is required.");return new Promise((function(i,s){r.getLockForTask(n,o).acquire().then((function(n){return r.sendInvocation(t,e).then((function(t){n(),i(t)})).catch((function(t){n(),s(t)}))}))}))}},{key:"close",value:function(){for(var t in this.tasks)for(var r in this.tasks[t])this.clearClientForTask(t,r);var n,o,i,s,a;(n=e,o="close",i=this,a=Kt($t(1&(s=3)?n.prototype:n),o,i),2&s&&"function"==typeof a?function(t){return a.apply(i,t)}:a)([])}}],n&&Rt(r.prototype,n),o&&Rt(r,o),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,n,o}(At);return"undefined"!=typeof window&&(window.Taproot=Qt),e})()));